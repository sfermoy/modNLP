<!doctype html>
<html lang="en" class="h-100">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="description" content="">
        <meta name="author" content="SS">
        <meta name="generator" content="SS1.0">
        <title>ModNLP LIVE</title>

        <link rel="stylesheet" href="css/jquery-ui.css">
        <script src="js/jquery.min.js"></script>
        <script src="js/jquery-ui.min.js"></script>

        <script src="js/d3.v3.min.js"></script>

            <script src="js/d3-selection-multi.v1.min.js"></script>
            <script src="js/interact.min.js"></script>
<!--            <link href="css/jsdoc-default.min.css" rel="stylesheet">-->



        <link href="css/bootstrap.min.css" rel="stylesheet"  crossorigin="anonymous">
        <!--<script src="js/bootstrap.min.js"></script>-->
        <script src="js/bootstrap.bundle.min.js" ></script>

            <link href="css/sortable.min.css" rel="stylesheet" />
<!--            <script src="js/sortable.min.js"></script>-->
         <link rel="stylesheet" type="text/css" href="css/w2ui.min.css">

        <!-- Favicons -->
        <meta name="theme-color" content="#7952b3">
        <style>
         body {
             padding-top: 60px;
         }
         /*@media (max-width: 979px) {*/
         /*  body {*/
         /*    padding-top: 0px;*/
         /*  }*/
         /*}*/


         .icon {
             background-color: white;
             background-image: url(https://cdn-icons-png.flaticon.com/512/2926/2926322.png);
             background-size: contain;
             /*size does not work*/
             display:block;
             width: 8px;
             background-repeat: no-repeat;
             padding-right: 20px;
         }
         .icon svg{
             width:100% !important;
         }
         .btn-group-xs > .btn, .btn-xs {
             /*padding: .25rem .4rem;*/
             font-size: .875rem;
             line-height: .5;
             /*border-radius: .2rem;*/
         }

         .bd-placeholder-img {
             font-size: 1.125rem;
             text-anchor: middle;
             -webkit-user-select: none;
             -moz-user-select: none;
             user-select: none;
         }

         @media (min-width: 768px) {
             .bd-placeholder-img-lg {
                 font-size: 3.5rem;
             }
         }

         .svg-container {
             background-color: white;
         }
         #chart2 {
             background-color: white;
         }


         #title {
             font-size: 20px;
             padding-bottom: 10px;
             padding-top: 20px;
             font-weight: 300;
         }

         #explanation {
             font-size: 12px;
             max-width: 620px;
             margin: 0 auto;
             padding-top: 10px;
             color: #ababab;
             font-weight: 300;
         }

         .y.axis line {
             fill: none;
         }

         .x.axis line {
             fill: none;
             stroke: #e0e0e0;
             shape-rendering: crispEdges;
         }

         .axis path {
             display: none;
         }

         .brush .extent {
             fill-opacity: .125;
             shape-rendering: crispEdges;
         }

         .panel-resizable {
             resize: both;
             overflow: hidden;
         }
         .panel-resizable svg{
             width:100% !important;

         }
         .panel-resizable-vert {
             resize: vertical;
             overflow: hidden;
         }

         .panel-resizable-vert::-webkit-resizer {
             background: lightsteelblue;
             background-image: url(https://cdn-icons-png.flaticon.com/512/3889/3889466.png);
             background-size: contain;
             /*size does not work*/
             display:block;
             width: 150px !important;
             height: 150px !important;
         }

         .panel-resizable-horz {
             resize: horizontal;
             overflow: hidden;
         }

         .panel-resizable-horz::-webkit-resizer {
             background: lightsteelblue;
             background-image: url(https://cdn-icons-png.flaticon.com/512/10025/10025081.png);

             background-size: contain;

             /*size does not work*/
             display:block;
             width: 150px !important;
             height: 150px !important;
         }
         .panel-resizable-horz svg{
             background: white;
             width:100% !important;

         }
          .panel-resizable-horz1 {
             resize: horizontal;
             overflow: hidden;
         }

         .panel-resizable-horz1::-webkit-resizer {
             background: lightsteelblue;
             background-image: url(https://cdn-icons-png.flaticon.com/512/10025/10025081.png);

             background-size: contain;

             /*size does not work*/
             display:block;
             width: 150px !important;
             height: 150px !important;
         }
         .panel-resizable-horz1 svg{
             background: white;
             width:100% !important;

         }


         .resize {
             display: inline !important; /* show when empty */
             fill: #7A7A7A;
             fill-opacity: 1;
             stroke: #7A7A7A;
             stroke-width: 2px;
         }

         .toolTip {
             position: absolute;
             display: none;
             min-width: 80px;
             height: auto;
             background: none repeat scroll 0 0 #ffffff;
             border: 1px solid #6F257F;
             padding: 14px;
             text-align: center;
             font-size: 12px;
         }

         .bar {
             /*shape-rendering: crispEdges;*/
         }

         /*HTML Horizonal Legend*/
         .country-name {
             margin: 0 !important;
         }
         .key-dot {
             display: inline-block;
             height: 10px;
             margin-right: .5em;
             width: 10px;
         }

         .removed { background: red;
             opacity:0.3  }
         .some { background: orange;
             opacity:0.3}

         .concord{
             background: white;
         }

         .concHighlight{
             background: lightyellow;
         }

         .concselected {
             background: lightgray;
         }

         #legend2{
             overflow:hidden;
         }
         .legend2 {
             float:left;
             margin-right: 1em;
         }
         #outerdiv {
             margin-bottom: 10px;
             margin-right: 15px;
             margin-left: 15px;
         }

         #metadatadiv img {
             width: 100%;
         }
         /*Sets the maximum height of the entire modal to 95% of the screen height*/
         #flistModal .modal-content {
             max-height: 95vh;
             overflow: scroll;
         }

         .kwhilight{
             font-weight: bold;
             color: blue;
         }

         /*!*Sets the maximum height of the modal body to 90% of the screen height*!*/
         /*.modal-body {*/
         /*  max-height: 90vh;*/
         /*}*/
         .concord{
          position: relative;
          top: 0;
          left: 0;
          height: 100%;
          width: 100%;
         }
        </style>


        <!-- Custom styles for this template -->
    </head>


    <header>
        <!-- Fixed navbar -->

        <nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
            <div class="container-fluid flex-row">
                <a class="navbar-brand" id="corpLabel" onclick="location.reload()" >OMC</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse flex-row" id="navbarCollapse">
                    <!--        <ul class="navbar-nav me-auto mb-2 mb-md-0">-->
                    <!--          <li class="nav-item">-->
                    <!--            <a class="nav-link active" aria-current="page" href="/search">Search</a>-->
                    <!--          </li>-->
                    <!--          <li class="nav-item">-->
                    <!--            <a class="nav-link" href="/mosaic">Mosaic</a>-->
                    <!--          </li>-->
                    <!--          &lt;!&ndash; <li class="nav-item">-->
                    <!--            <a class="nav-link disabled" href="#" tabindex="-1" aria-disabled="true">Disabled</a>-->
                    <!--          </li> &ndash;&gt;-->
                    <!--        </ul>-->
                    <button class="btn btn-secondary me-2" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasExample" aria-controls="offcanvasExample">
                        Menu
                    </button>
                    <div class="d-flex justify-content-end col">
                        <form class="d-flex justify-content-end" id="searchform">
                            <input class="form-control me-2 " id="keyword" type="text" placeholder="Search" value="keyword" aria-label="Text">
                            <button class="btn btn-secondary  me-2" type="button" onclick="submitKeyword('keyword')">Search</button>

                            <!--          <button class="btn btn-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">-->
                            <!--    Options-->
                            <!--  </button>-->
                        </form>
                    </div>

                    <div class="d-flex justify-content-end col">
                        <a class="navbar-brand" href="https://sourceforge.net/projects/modnlp/" >ModNLP</a>
                    </div>
                </div>
            </div>
        </nav>
    </header>



    <div class="offcanvas offcanvas-start" data-bs-scroll="true" data-bs-backdrop="false" tabindex="-1" id="offcanvasExample" aria-labelledby="offcanvasExampleLabel">
        <div class="offcanvas-header">
            <h5 class="offcanvas-title" id="offcanvasExampleLabel">ModNLP Options</h5>
            <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
        </div>
        <div class="offcanvas-body">
            <div class="border rounded my-2 p-2">
                <h4>Selection Tools</h4>
<!--                <div class="form-check form-switch" style="margin-left: 10px;">-->
<!--&lt;!&ndash;                    <input class="form-check-input" type="checkbox" id="flexSwitchsubcorpus" onclick="subcorpusSwitch()">&ndash;&gt;-->
<!--&lt;!&ndash;                    <label class="form-check-label" for="flexSwitchsubcorpus">Activate/Deactivate Subcorpus Selection</label>&ndash;&gt;-->
<!--                </div>-->
                <button class="btn btn-secondary" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#exampleModal" onclick="activateSubcorpus()">
                    Corpus Selection
                </button>
            </div>
            <div class="border rounded my-2 p-2">
                <h4>Analysis Tools</h4>
                <button class="btn btn-secondary" type="button" class="btn btn-primary" data-bs-toggle="modal" onclick="getFreqkList()" data-bs-target="#flistModal">
                    Frequency List
                </button>
            </div>
            <div class="border rounded my-2 p-2">
                <h4>Save/Load Concordance</h4>
                <button class="btn btn-secondary" type="button" class="btn btn-primary"  onclick="dlConcordance()" >
                    Download Concordance
                </button>
                <div class="mt-2">
                <button class="btn btn-secondary" type="button" class="btn btn-primary "  onclick="loadConcordance()">
                    Load Concordance
                </button>
                </div>
            </div>

            <!-- <h5 class="offcanvas-title" id="offcanvasExampleLabelsub">Components</h5>-->
        </div>
    </div>



    <!-- Modal corpus selection -->
    <div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Corpus Selection</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card card-body col">
                        <!-- <img src="https://genealogies.mvm.ed.ac.uk/omc/headers/omc000001-figure-1-1.png"> -->
                        <select class="form-select" id = "corpusSelect" onchange="corpChanged()">
                            <option value="/gok-en-server">Gok English</option>
                            <option selected value="/omc-server">OMC</option>
                        </select>

                        <select class="form-select" id = "markdownSelect">
                            <option value="yes">Images</option>
                            <option selected value="no">No Images</option>
                        </select>


                        <form>
                            <fieldset class="row gy-2 gx-3 align-items-center" id="subcorpusForm" enabled>

                            </fieldset>
                        </form>

                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"  onclick="clearSubcorpus()">Clear</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Save Selection</button>

                </div>
            </div>
        </div>
    </div>

    <!-- Modal FF -->
    <div class="modal fade" id="flistModal" tabindex="-1" aria-labelledby="flistModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="flistModalLabel">Frequency List</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" onclick="closeflist()" aria-label="Close"></button>
                </div>
                <div class="modal-body  overflow-scroll">
                    <div id ="FLNUM" class="card-body col " style="height: 50px;"></div>
                    <div id ="flistdiv" class="card card-body col " style="height: 600px;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary"  onclick="closeflist()" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Extract -->
    <div class="modal fade" id="exampleModal1" tabindex="-1" aria-labelledby="exampleModalLabel1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card card-body col">

                        <div class="col fade show" id="extract" role="tabpanel" aria-labelledby="home-tab">
                            <div class="container">
                                <h1 class="mt-5">Extract Controls</h1>
                                <div class="border rounded">
                                    <div class="form-outline" style="width: 22rem;">
                                        <label class="form-label" for="extractnumber">Extract Size (number of characters)</label>
                                        <div class="input-group">
                                            <input value="300" type="number" max="1000" id="extractnumber" class="form-control" />
                                            <br>
                                            <button type="button" class="btn btn-primary mr-1" id="updateExtract" onclick="updateExtract()">Update</button>
                                        </div>
                                        <br>
                                    </div>
                                </div>

                                <div  class="border rounded">
                                    <br>
                                    <p id="extractDiv" class="text-center">Extract will display here. Please select a line in the concordance view.</p>

                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="modal-footer">
                </div>
            </div>
        </div>
    </div>



    <!-- metadata -->
    <div class="modal fade" id="exampleModal3" tabindex="-1" aria-labelledby="exampleModalLabel3" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="card card-body col">
                        <div class="col fade show" id="metadata" role="tabpanel" aria-labelledby="home-tab">
                            <div class="container">
                                <h1 class="mt-5">Metadata View</h1>
                                <div  class="border rounded">
                                    <br>
                                    <p id="metadatadiv" class="text-left">Metadata will display here. Please select a line in the concordance view.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
            </div>




            <!--MAIN CANVAS-->
            <div id="outerdiv">
                <div class="border">

                    <a class="btn btn-secondary btn-xs d-block" data-bs-toggle="collapse" href="#collapseExampleconc" role="button" aria-expanded="true" aria-controls="collapseExampleconc">
                        Concordance Options
                    </a>
                    <div class="collapse show" id="collapseExampleconc">
                        <div class="card card-body">
                            <div class="form-check form-switch" style="margin-left: 10px;">
                                <div class="input-group row ">
                                    <div class="btn-group col ">
                                        <div class="dropdown">
                                            <button class="btn btn-secondary dropdown-toggle btn-danger p-2 btn-xs" type="button" id="dropdownMenu2" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                                                Sort position 1
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
                                                <li><button class="dropdown-item" type="button" onclick="sort('filename')">Filename</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('keyword')">Keyword</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('left1')">Left 1</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('left2')">Left 2</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('left3')">Left 3</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('left4')">Left 4</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('left5')">Left 5</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('right1')">Right 1</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('right2')">Right 2</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('right3')">Right 3</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('right4')">Right 4</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort('right5')">Right 5</button></li>
                                            </ul>
                                        </div>
                                        <div class="dropdown">
                                            <button class="btn btn-secondary dropdown-toggle btn-warning p-2 btn-xs" type="button" id="dropdownMenu3" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                                                Sort position 2
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
                                                <li><button class="dropdown-item" type="button" onclick="sort1('filename')">Filename</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('keyword')">Keyword</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('left1')">Left 1</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('left2')">Left 2</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('left3')">Left 3</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('left4')">Left 4</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('left5')">Left 5</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('right1')">Right 1</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('right2')">Right 2</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('right3')">Right 3</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('right4')">Right 4</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort1('right5')">Right 5</button></li>
                                            </ul>
                                        </div>
                                        <div class="dropdown">

                                            <button class="btn btn-secondary dropdown-toggle btn-success p-2 btn-xs" type="button" id="dropdownMenu4" data-bs-toggle="dropdown" data-bs-display="static" aria-expanded="false">
                                                Sort position 3
                                            </button>
                                            <ul class="dropdown-menu" aria-labelledby="dropdownMenu2">
                                                <li><button class="dropdown-item" type="button" onclick="sort2('filename')">Filename</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('keyword')">Keyword</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('left1')">Left 1</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('left2')">Left 2</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('left3')">Left 3</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('left4')">Left 4</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('left5')">Left 5</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('right1')">Right 1</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('right2')">Right 2</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('right3')">Right 3</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('right4')">Right 4</button></li>
                                                <li><button class="dropdown-item" type="button" onclick="sort2('right5')">Right 5</button></li>
                                            </ul>
                                        </div>
                                    </div>

                                    <div class="btn-group col">
                                        <button class="btn btn-secondary btn-xs " type="button" id="extbtn"  data-bs-display="static" onclick="clickExtract()" >
                                            Show Extract
                                        </button>
                                        <button class="btn btn-secondary btn-xs" type="button" id="metadispbtn"  data-bs-display="static" onclick="clickMetadata()" >
                                            Show Metadata
                                        </button>
                                    </div>

                                    <div class="btn-group col">
                                        <button class="btn btn-secondary btn-xs" type="button" id="deletebtn"  data-bs-display="static"  onclick="deleteLine()"  >
                                            Delete Selected Lines
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="contentBox">
                    <div id="linesreturned"> </div>
                    <!-- <div class="col container panel panel-default" id="profile" role="tabpanel" aria-labelledby="profile-tab" >-->
                    <div class="border rounded panel-body panel-resizable-vert " id="concbox" style="width: 100%; height: 300px;">



<!--                            <div class="d-flex lazy " id="filename"  style="line-height:1.5em;padding-bottom:7px;padding-top:7px;margin-top: 30px;font-size:12px;flex-shrink: 0;left: 0;position: -webkit-sticky;position:-webkit-sticky;position: sticky;">-->
<!--                            </div>-->
<!--                            <div class="d-flex p-2" id="leftconc"  style="line-height:1.5em;padding:5px;margin-top: 30px;font-size:12px;resize:horizontal;">-->
<!--                            </div>-->

<!--                            <div class="d-flex p-2" id="keyworddisplay" style="line-height:1.5em;padding:5px;margin-top: 30px;font-size:12px;flex-shrink: 0;">-->
<!--                            </div>-->

<!--                            <div class="d-flex p-2 " id="rightconc" style="line-height:1.5em;padding:5px;margin-top: 30px;font-size:12px;flex-shrink: 0;">-->
<!--                            </div>-->
                    </div>
                    <!--   </div>-->




                    <div class="row">
                        <div class="draggable1 col container panel panel-default" style="clear:both" id="home" role="tabpanel" aria-labelledby="home-tab">

                            <div class="border rounded panel-body panel-resizable-horz">


                                <!--          <div class="card">-->
                                <!--            <h5 class="card-header">-->
                                <!--                <a class="collapsed d-block" data-toggle="collapse" href="#collapse-collapsed" aria-expanded="true" aria-controls="collapse-collapsed" id="heading-collapsed">-->
                                <!--                    Collapsible Group Item #1-->
                                <!--                </a>-->
                                <!--            </h5>-->
                                <!--            <div id="collapse-collapsed" class="collapse" aria-labelledby="heading-collapsed">-->
                                <!--                <div class="card card-body">-->
                                <!--                    sdfsdfsdads-->

                                <!--                </div>-->
                                <!--            </div>-->
                                <!--        </div>-->
                                <div class="border rounded row">

                                    <a class="btn btn-secondary dropdown-toggle btn-xs d-block col " data-bs-toggle="collapse" href="#collapseExample" role="button" aria-expanded="false" aria-controls="collapseExample">
                                        Mosaic Options
                                    </a>
<!--                                    <div class="icon handle rounded col-xs ">-->


                                </div>
                                <div class="collapse" id="collapseExample">
                                    <div class="card card-body">
                                        <div class="form-check form-switch" style="margin-left: 10px;">
                                            <input class="form-check-input" type="checkbox" id="flexSwitchStopword" onclick="checkSwitch()">
                                            <label class="form-check-label" for="flexSwitchStopword">Remove Stopwords</label>
                                        </div>
                                        <div class="border rounded">
                                            <div id="slider-range" class="w-50 m-2 "></div>
                                            <input id="amount" class="w-100 " type="text" />
                                        </div>
                                    </div>
                                </div>

                                <div id="chart"></div>


                            </div>
                        </div>


                        <!--    <p class="lead">Search word and display concordance</p>-->

                        <div class="draggable2 col container panel panel-default" style="clear:both" id="contact" role="tabpanel" aria-labelledby="contact-tab" >
                            <div class="border rounded panel-body panel-resizable-horz1">

                                <div class="border rounded row">
                                    <a class="btn btn-secondary dropdown-toggle btn-xs d-block" id="metabtn" data-bs-toggle="collapse" href="#collapseExamplemeta" role="button" aria-expanded="false" aria-controls="collapseExamplemeta">
<!--                                    <a class="btn btn-secondary dropdown-toggle btn-xs d-block col" id="metabtn" data-bs-toggle="collapse"  role="button" aria-expanded="false" aria-controls="collapseExamplemeta">-->
                                        Metafacet Help
                                    </a>
<!--                                    <div class="icon handle rounded col-xs "></div>-->
                                    

                                </div>

                                <div class="collapse" id="collapseExamplemeta">
                                    <div class="card card-body">
                                        <ul>
                                            <li> Click once to select an attribute, click again to unselect it</li>

                                            <li> Click Remove Selected to delete concordance lines associated with attribute</li>

                                            <li> Shift+click on an attribute to select all others, click Remove Selected to delete all lines except those associated with the clicked attribute</li>

                                            <li> Use the dropdown to switch between attribute facets</li>
                                        </ul>
<!--                                        <div id="legend2">-->
<!--                                            <div class="legend2"> <p class="country-name"><span class="key-dot removed"></span>All Lines Removed</p> </div>-->
<!--                                            <div class="legend2"> <p class="country-name"><span class="key-dot some"></span>Some Lines Removed</p> </div>-->
<!--                                        </div>-->
<!--                                        <button type="button" class="btn btn-primary btn-xs " id="metafacetRemove" onclick="hide()">Remove Selected</button>-->

                                    </div>
                                </div>
                                <div>
                                <div class="container-fluid row">
                                    <div class=" col">
                                        <label for="metatextbox">Selected Attributes</label><textarea class="border rounded text-wrap w-100" id="metatextbox"  type="text"  style="font-size: 12px;overflow-y:scroll;resize: none; height: 30px" readonly></textarea>
                                    </div>
                                    <div class=" col">
                                        <label for="metatextbox1">Removed Attributes</label><textarea class="border rounded text-wrap w-100" id="metatextbox1"  type="text"  style="font-size: 12px;overflow-y:scroll;resize: none;height: 30px" readonly></textarea>
                                    </div>
                                </div>
                                <button type="button" class="btn btn-primary btn-xs m-1 " id="metafacetRemove" onclick="hide()">Remove Selected</button>
                                <div id="chart2"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
           </div>



<script type="text/javascript" src="js/w2ui.js"></script>
<script>
// widget configuration

let config = {
    grid: {
        name: 'grid',
        recordHeight : 20,
        show: {
            footer: false,
            toolbar: false
        },
        columns: [
            { field: 'tablefname', text: 'Filename', size: '120px', sortable: false, resizable: true },
            { field: 'tableLeftCtx', text: 'Left context', size: '800px', sortable: false, resizable: true,  attr: 'align=right' },
            { field: 'tablekeyword', text: 'Keyword', size: '85px', sortable: false, resizable: true, attr: 'align=center' },
            { field: 'tableRightCtx', text: 'Right Context', size: '800px', sortable: false, resizable: true, attr: 'align=left' }
        ]
    }
}

let flistConfig = {
    grid: {
        name: 'grid1',
        recordHeight : 20,
        show: {
            footer: false,
            toolbar: true,
            lineNumbers: true
        },
        columns: [
            { field: 'rank', text: 'Rank', sortable: true, resizable: true },
            { field: 'type', text: 'Type', sortable: true,  attr: 'align=left', editable: { type: 'text' } },
            { field: 'count', text: 'Count', sortable: true, resizable: true, attr: 'align=left' }
        ]
    }
}


// initialization
let grid = new w2grid(config.grid)
let grid1 = new w2grid(flistConfig.grid)

             const position = {x: 0, y: 0}
             // interact('.draggable1').draggable({
             //     modifiers: [
             //         interact.modifiers.restrict({
             //             restriction: '#contentBox',
             //             endOnly: true
             //         })
             //     ],
             //     listeners: {
             //         move(event) {
             //             position.x += event.dx
             //             position.y += event.dy
             //             event.target.style.transform =
             //                 `translate(${position.x}px, ${position.y}px)`
             //         }
             //
             //     },
             //     allowFrom: '.handle',
             // })
             //
             // const position2 = {x: 0, y: 0}
             // interact('.draggable2').draggable({
             //     modifiers: [
             //         interact.modifiers.restrict({
             //             restriction: '#contentBox',
             //             endOnly: true
             //         })
             //     ],
             //     listeners: {
             //         move(event) {
             //             position2.x += event.dx
             //             position2.y += event.dy
             //             event.target.style.transform =
             //                 `translate(${position2.x}px, ${position2.y}px)`
             //         }
             //
             //     },
             //     allowFrom: '.handle',
             // })

                 interact('.panel-resizable-horz')
             .resizable({
               edges: { top: false, left: true, bottom: true, right: true },
               listeners: {
                 move: function (event) {
                   let { x, y } = event.target.dataset

                   x = (parseFloat(x) || 0) + event.deltaRect.left
                   y = (parseFloat(y) || 0) + event.deltaRect.top

                   Object.assign(event.target.style, {
                     width: `${event.rect.width}px`,
                     height: `${event.rect.height}px`,
                     transform: `translate(${x}px, ${y}px)`
                   })

                   Object.assign(event.target.dataset, { x, y })
                 }
               }
             })

interact('.panel-resizable-horz1')
             .resizable({
               edges: { top: false, left: true, bottom: false, right: true },
               listeners: {
                 move: function (event) {
                   let { x, y } = event.target.dataset

                   x = (parseFloat(x) || 0) + event.deltaRect.left
                   y = (parseFloat(y) || 0) + event.deltaRect.top

                   Object.assign(event.target.style, {
                     width: `${event.rect.width}px`,
                     height: `${event.rect.height}px`,
                     transform: `translate(${x}px, ${y}px)`
                   })

                   Object.assign(event.target.dataset, { x, y })
                 }
               }
             })

             $( document ).ready(function() {
                 $(".panel-resizable-horz").resizable({
                     handles: " e, s, w, se, sw"
                 });
                 $(".panel-resizable-horz1").resizable({
                     handles: " e, w"
                 });


                 submitKeyword("keyword")
             });



             var slider = $("#slider-range").slider({
                 range: true,
                 min: 0,
                 max: 100,
                 step: 1,
                 values: [5, 100],
                 slide: function (event, ui) {
                     $("#amount").val("Tiles with frequency above " + nonlinear(ui.values[0]) + " and below "+ nonlinear(ui.values[1])+"  will be displayed." );
                 },
                 change: function(event, ui) {
                     redrawMosaic()
                 }
             });

             $("#amount").val("Tiles with frequency above " + nonlinear($("#slider-range").slider("values", 0)) +
                              " and below "+ + nonlinear($("#slider-range").slider("values", 1))+"  will be displayed ");

             function nonlinear(val) {
                 var toPresent = 0;
                 if (val <= 50) {
                     toPresent = (val / 10) ;
                 } else if (val <= 92) {
                     toPresent = (val-46)/2;
                 } else {
                     toPresent = (val -90)*10 ;
                 };
                 return String(toPresent)
             }

            </script>

            <script type="text/javascript">


             var currentData;
             var currentKeyword;
             var sortpos ="filename";
             var headersfetched = false;
             var headermap = {};
             var concrdance ="";
             var isSectionedHeader = true;
             var filterStopwords = false;
             var removedViaMetafacet = new Set();
             var toberemovedViaMetafacet =  new Set();
             var removedViaDelete = new Set();
             var indextoremove =[];
             var sortClick = false;
             var subcorpatts = [];
             var subcorpattsLabels = [];
             var subcorpenabled = false;
             var socket ;
             var sort1pos = "filename";
             var sort2pos = "filename";
             var sort3pos = "filename";

             var filepath = ""
             var extractpos = "";
             var cline = "";
             var extractsection = "";
             var Mosaicword ="";
             hidmetafacetsel = false;


             var  selectHtml ="<div class=\"col-md-3 form-group border rounded \"><label for=\"theclassSelect\">titleText</label><div class=\"col-auto\"  ><select class=\"form-select theclass\"  style=\"overflow-x:scroll;\" id=\"theclassSelect\"  onchange=\"updateTextBox()\" size=\"10\" multiple aria-label=\"size 10 select theclass\"></select> <div class=\"form-check\">" +
                              "<input class=\"form-check-input\" type=\"checkbox\" onclick='checkboxClick()' value=\"\" id=\"theclassChecked\">" +
                              "<label class=\"form-check-label\" for=\"theclassChecked\">exclude</label></div><div class=\"dropdown\">" +
                              " <button class=\"btn btn-secondary dropdown-toggle btn-secondary p-2 btn-xs\" type=\"button\" id=\"theclassdropper\"  data-bs-toggle=\"dropdown\" data-bs-display=\"static\" aria-expanded=\"false\">" +
                              "                                And" +
                              "                              </button>" +
                              "                              <ul class=\"dropdown-menu\" aria-labelledby=\"dropdownMenu2\">" +
                              "                                <li><button class=\"dropdown-item\" type=\"button\" onclick='dropdownclick(\"Or\",\"theclassdropper\")'>Or</button></li>" +
                              "                                <li><button class=\"dropdown-item\" type=\"button\" onclick='dropdownclick(\"And\",\"theclassdropper\")'>And</button></li>" +
                              "                              </ul>" +
                              "                            </div></div></div>"
                              var  optionHtml ="<option value=\"opVal\">opVal</option>"
             var  subTextHtml =" <label for=\"supcorptextbox\">Text Query</label><textarea class=\"border rounded form-control text-wrap\" id=\"supcorptextbox\"  type=\"text\"  style=\"width: 45rem;height: 20rem;margin:13px\"></textarea>"

             var initselectvalue = document.getElementById("corpusSelect").value
             fetchSubcorpusAttributesd(initselectvalue )

             document.getElementById('searchform').addEventListener('submit', function(e) {
                 submitKeyword('keyword')
                 e.preventDefault();
             }, false);

             function checkSwitch()
             {
                 var checkbox = document.getElementById('flexSwitchStopword');
                 if (checkbox.checked != true)
                 {
                     filterStopwords = false;
                     redrawMosaic()
                 }else{
                     filterStopwords = true;
                     redrawMosaic()
                 }
             }

             function subcorpusSwitch()
             {
                 if (checkbox.checked != true)
                 {
                     subcorpenabled = false;
                 }else{
                     subcorpenabled = true;
                 }
             }

             function ProcessMosaicClick(pos,wordpos){
                 highlightWord(pos, wordpos);
                 sort(pos);
             }

             function checkboxClick(){
                 updateTextBox();
             }

             function activateSubcorpus(){
                 subcorpenabled = true;
             }


             function clearSubcorpus(){
                 document.getElementById("supcorptextbox").value = "";
                 let corp = document.getElementById("corpusSelect").value;
                 fetchSubcorpusAttributesd(corp)
                 var el = document.getElementById("corpusSelect");
                 var text = el.options[el.selectedIndex].innerHTML;
                 document.getElementById("corpLabel").innerHTML = text;
             }

             function corpChanged(){
                 let corp = document.getElementById("corpusSelect").value;
                 fetchSubcorpusAttributesd(corp)
                 var el = document.getElementById("corpusSelect");
                 var text = el.options[el.selectedIndex].innerHTML;
                 document.getElementById("corpLabel").innerHTML = text;
                 headersfetched = false;
                 console.log("corpus changed");
             }

             function dropdownclick(logic,classstr){
                 let dropper = document.getElementById(classstr);
                 dropper.innerText = logic;
                 updateTextBox();
             }

             function updateTextBox(){
                 let tb = document.getElementById("supcorptextbox")
                 tb.value = ""
                 let first = true;
                 for (const attElement of subcorpatts) {
                     let selbox = document.getElementById(attElement + "Select")
                     let cbox = document.getElementById(attElement + "Checked")
                     let dropper = document.getElementById(attElement + "dropper")
                     varselecteditems = $(selbox).val();
                     var txtstring = "";
                     if (varselecteditems.length > 0 & !first) {
                         txtstring += dropper.innerText.toString().toLowerCase().trim() + " ";
                     }
                     for (const selitm of varselecteditems) {
                         if (txtstring === "" || txtstring === "and " || txtstring === "or ") {
                             if (cbox.checked){
                                 txtstring += "(not ($s/" + attElement + "=%27" + selitm.trim().replaceAll(" ","%20").replaceAll(".","%2E").replaceAll("_","%5F") + "%27";
                             }else{
                                 txtstring += "($s/" + attElement + "=%27" + selitm.trim().replaceAll(" ","%20").replaceAll(".","%2E").replaceAll("_","%5F") + "%27";
                             }
                         } else {
                             txtstring += " or $s/" + attElement + "=%27" + selitm.trim().replaceAll(" ","%20").replaceAll(".","%2E").replaceAll("_","%5F") + "%27";
                         }
                     }
                     if (varselecteditems.length > 0) {
                         if (cbox.checked){
                             tb.value += txtstring + ")) ";
                             first = false;
                         }else{
                             tb.value += txtstring + ") ";
                             first = false;
                         }

                     }
                 }

             }

             function dlConcordance(){
                 var element = document.createElement('a');
                 var filename = "concordance.txt";
                 element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(keyword.value+"\n"+currentData));
                 element.setAttribute('download', filename);

                 element.style.display = 'none';
                 document.body.appendChild(element);

                 element.click();

                 document.body.removeChild(element);
             }
             function loadConcordance(){
                 var input = document.createElement('input');
                 input.type = 'file';
                 input.onchange = e => {

                     // getting a hold of the file reference
                     var file = e.target.files[0];

                     // setting up the reader
                     var reader = new FileReader();
                     reader.readAsText(file,'UTF-8');

                     // here we tell the reader what to do when it's done reading...
                     reader.onload = readerEvent => {
                         var content = readerEvent.target.result; // this is the content!
                         var lines = content.split('\n');
                         var kword= lines[0]
                         // remove one line, starting at the first position
                         lines.splice(0,1);
                         // join the array back into a single string
                         content = lines.join('\n');
                         dataProcess(content,kword)
                     }
                 }
                 input.click();
             }


             function redrawMosaic(){
                 dataProcessMosaic(currentData,currentKeyword);
             }

             function sort(pos){
                 sortClick = true;
                 sortpos = pos;
                 sort1pos = pos
                 document.getElementById("dropdownMenu2").innerHTML = pos;
                 dataProcess(currentData,currentKeyword);
                 sortClick = false;
             }
             function sort1(pos){
                 sortClick = true;
                 sort2pos = pos
                 document.getElementById("dropdownMenu3").innerHTML = pos;
                 dataProcess(currentData,currentKeyword)
                 sortClick = false;
                 return true;
             }
             function sort2(pos){
                 sortClick = true;
                 sort3pos = pos
                 document.getElementById("dropdownMenu4").innerHTML = pos;
                 dataProcess(currentData,currentKeyword)
                 sortClick = false;
             }


             function highlightWord(pos,selectedWord){
                    Mosaicword = selectedWord;
                    // const collection = Array.from(document.getElementsByClassName(selectedWord));
                    // collection.forEach(element => {
                    //   element.style.color = "purple";
                    //   element.classList.add("concHighlight");
                    //   element.parentElement.classList.add("concHighlight")
                    //     //Disabled highlight of full line as nested selections are killing performance
                    //   // const collection2 = Array.from(document.getElementsByClassName(element.parentElement.classList[2]));
                    //   // collection2.forEach(element2 => {
                    //   //   element2.classList.add("concHighlight");
                    //   // });
                    // });
                 // setTimeout(function (d) {
                 //     console.log(collection[0])
                 //     w2ui.grid.scrollIntoView(parseInt(collection[0].parentElement.classList[2]));
                 // },200)
             }

             let data = ""
             var requestOptions = {
                 method: 'GET',
             };

             async function fetchSubcorpusAttributesd(corpus){
                 let text0 = 'https://genealogies.mvm.ed.ac.uk'
                 let text1 =text0.concat(corpus).concat('/attchooser?')
                 let text3 ='request=attchooserspecs'
                 let text4 = text1.concat(text3)
                 let attributes ="";
                 let form = document.getElementById("subcorpusForm")
                 form.innerHTML="";
                 try {
                     let response = await fetch(text4,requestOptions)
                     attributes = await response.text();
                 }
                 catch (e) {
                     return e.message;
                 }
                 attributes = attributes.trim().split(";")

                 let selectors = attributes.filter((element, index) => {
                     return index % 2 === 1;
                 })
                 let selectorLabels = attributes.filter((element, index) => {
                     return index % 2 === 0;
                 })
                 subcorpatts = selectors;
                 subcorpattsLabels = selectorLabels;
                 for (const selectorsKey in selectors) {
                     fetchSubcorpusAttribute(corpus,selectors[selectorsKey],selectorLabels[selectorsKey])
                 }

                 form.insertAdjacentHTML( 'beforeend', subTextHtml);


             }

             // http://genealogies.mvm.ed.ac.uk:1245/attoptions?request=attoptions&xqueryattribs=
             async function fetchSubcorpusAttribute(corpus,selector,title){
                 let text0 = 'https://genealogies.mvm.ed.ac.uk'
                 let text1 =text0.concat(corpus).concat('/attoptions?')
                 let text3 ='request=attoptions&xqueryattribs='
                 let text4 = text1.concat(text3).concat(selector)
                 let attoption ="";
                 let form = document.getElementById("subcorpusForm")
                 title = title.split("/");
                 title= title[title.length-1]
                 form.insertAdjacentHTML( 'beforeend',selectHtml.replaceAll("theclass",selector).replaceAll("titleText",title))
                 try {
                     let response = await fetch(text4,requestOptions)
                     attoption = (await response.text());
                     attoption = attoption.split(',');
                     for (let i = 0; i <attoption.length ; i++) {
                         let att = attoption[i];
                         if(att.charAt(0) ==="_"){
                             att = att.replace("_", "");
                         }
                         if(att.charAt(att.length-1) ==="_"){
                             att = att.substring(0, att.length-1);
                         }
                         attoption[i] = att;
                     }

                 }
                 catch (e) {
                     return e.message;
                 }
                 let thisBox = document.getElementById(selector+"Select")
                 for (let attoptionElement of attoption) {
                     thisBox.insertAdjacentHTML( 'beforeend',optionHtml.replaceAll("opVal",attoptionElement));
                 }
             }


             async function fetchConcordance(keyword,corpus,markdowSelect) {
                 removedViaMetafacet = new Set();
                 toberemovedViaMetafacet = new Set();
                 removedViaDelete = new Set();
                 indextoremove =[];
                 sortpos ="filename";
                 let text0 = 'https://genealogies.mvm.ed.ac.uk'
                 let text1 =text0.concat(corpus).concat('/concordancer?sgml=').concat(markdowSelect).concat('&keyword=')
                 let text2 =text1.concat(keyword.replaceAll("+","%2b"))
                 let text3 ='&case=insensitive&context=130&request=concord'
                 let text4 = text2.concat(text3)

                 if(subcorpenabled && document.getElementById("supcorptextbox").value != "" ) {
                     text4 = text4.concat("&xquerywhere=" + document.getElementById("supcorptextbox").value)
                 }
                 try {
                     let concordancebox = document.getElementById("concbox")
                     concordancebox.innerHTML = "<div class=\"spinner-border text-success d-flex align-items-center justify-content-center\" role=\"status\">" +
                                                "  <span class=\"visually-hidden\">Loading...</span>" +
                                                "</div>";
                     // let fnfn = document.getElementById("filename")
                     // fnfn.innerHTML = "<br><br><h2>Loading Concordance          </h2>";
                     // let lctx = document.getElementById("leftconc")
                     // lctx.innerHTML = "";
                     // let rttx = document.getElementById("rightconc")
                     // rttx.innerHTML = "";
                     let chartBox = document.getElementById("chart")
                     chartBox.innerHTML = "<br><br><h2>Loading Concordance          </h2><div class=\"spinner-border text-success d-flex align-items-center justify-content-center\" role=\"status\">" +
                                          "  <span class=\"visually-hidden\">Loading...</span>" +
                                          "</div>";
                     let chartBox2 = document.getElementById("metachart")
                     chartBox2.innerHTML = "<div class=\"spinner-border text-success d-flex align-items-center justify-content-center\" role=\"status\">" +
                                           "  <span class=\"visually-hidden\">Loading...</span>" +
                                           "</div>";

                     let response = await fetch(text4,requestOptions)
                     data = await response.text();
                 }
                 catch (e) {
                     console.log(e.message)
                     return e.message;
                 }
                 currentData = data;
                 currentKeyword = keyword;
                 dataProcess(data,keyword);
                 dataProcessMosaic(data,keyword);
                 if(!headersfetched) {
                     console.log("getting headers "+corpus)
                      await fetchheader(corpus);
                 }
                 else{
                     buildConcMetadata();
                 }
             }

             async function fetchheader(corpus) {
                 let text0 = 'https://genealogies.mvm.ed.ac.uk'
                 let text1 = text0.concat(corpus).concat('/allheaders?request=dldHeaders')
                 let headers = "";
                 try {
                     let response = await fetch(text1,requestOptions)
                     headers = await response.text();
                 }
                 catch (e) {
                     return e.message;
                 }
                 headersfetched = true;
                 processHeaders(headers)
             }

             function submitKeyword(id){
                 Mosaicword ="";
                 var value = document.getElementById(id).value
                 var selectvalue = document.getElementById("corpusSelect").value
                 var markdowSelect = document.getElementById("markdownSelect").value
                 sort1pos = "filename";
                 sort2pos = "filename";
                 sort3pos = "filename";
                 document.getElementById("dropdownMenu2").innerText = "Sort position 1";
                 document.getElementById("dropdownMenu3").innerText = "Sort position 2";
                 document.getElementById("dropdownMenu4").innerText = "Sort position 3";
                 document.getElementById("metatextbox1").innerHTML = "";

                 fetchConcordance(value,selectvalue,markdowSelect)
             }

             function clickExtract() {
                 fetchextract(document.getElementById("corpusSelect").value,filepath,extractpos)
                 var myModal1 = new bootstrap.Modal(document.getElementById("exampleModal1"), {});
                 myModal1.show();
             }

             function clickMetadata() {
                 fetchSingleMetadata(document.getElementById("corpusSelect").value,filepath)
                 var myModal1 = new bootstrap.Modal(document.getElementById("exampleModal3"), {});
                 myModal1.show();
             }

             function deleteLine() {
                 // console.log(grid.getSelection())
                 //     grid.getSelection().forEach(element1 => {
                 //         console.log(element1)
                 //         console.log(grid.get(element1)["tablefname"].split("class=\"")[1].split(" ")[1])
                 //        removedViaDelete.add(grid.get(element1)["tablefname"].split("class=\"")[1].split(" ")[1]);
                 //    });

                 w2ui.grid.delete(true);
                 document.getElementById("linesreturned").innerHTML ="Lines returned : "+ grid.records.length;

                 // buildConcMetadata();
                 // redrawMosaic();
             }

             function clickConc(file,filePos,section,line){
                 extractpos = filePos;
                 filepath = file;
                 cline = line;
                 extractsection = section;

                    const collection0 = Array.from(document.getElementsByClassName("concord"));
                    collection0.forEach(element => {
                        element.classList.remove("concselected");
                    });

                    const collection = Array.from(document.getElementsByClassName(line));
                    collection.forEach(element1 => {
                        element1.classList.add("concselected");
                    });

             }
             //https://genealogies.mvm.ed.ac.uk/freqlist//?casesensitive=FALSE&maxlistsize=0&request=freqlist&skipfirst=0
             async function getFreqkList(){
                 let text0 = 'https://genealogies.mvm.ed.ac.uk'
                 let text1 =text0.concat(document.getElementById("corpusSelect").value).concat('/freqlist//')
                 let text2 =text1.concat("?casesensitive=FALSE&maxlistsize=0&request=freqlist&skipfirst=0")
                 let text4 = text2
                 if(subcorpenabled && document.getElementById("supcorptextbox").value != "" ) {
                     text4 = text4.concat("&xquerywhere=" + document.getElementById("supcorptextbox").value)
                 }
                 try {
                     grid1.clear()
                     let response = await fetch(text4,requestOptions)
                     data = await response.text();


                     // var output = document.getElementById('flistdiv');

                     var lines = data.replaceAll(".", '').replaceAll(",", '').replaceAll("%", '').split("\n");
                     htmlstr = "<h3> Number of Tokens: "
                     htmlstr += lines[0].split("<sep/>")[2]+"</h3>>"
                     let rid =0
                       for (let i = 2; i < lines.length ; i++) {
                           line = lines[i].toString();
                           linesplit = line.split("<sep/>")
                           isnum = /^\d+$/.test(linesplit[1])
                           if (!isnum) {
                               grid1.records.push({
                                   recid: rid,
                                   rank: Number(linesplit[0]),
                                   type: linesplit[1],
                                   count: Number(linesplit[2])

                               });
                               rid+=1;
                           }
                       }
                     //htmlstr += "</tbody></table>"
                     // output.innerHTML = htmlstr;
                     grid1.render('#flistdiv');
                     document.getElementById("FLNUM").innerHTML =htmlstr
                 }
                 catch (e) {
                     return e.message;
                 }

             }

             function closeflist(){
                 var output = document.getElementById('flistdiv');
                 output.innerHTML = "<div class=\"spinner-border text-primary\" role=\"status\">\n" +
                                    "  <span class=\"visually-hidden\">Loading...</span>\n" +
                                    "</div>"

             }


             //need to parse correctly
             async function fetchSingleMetadata(corpus,file){
                 let text0 = 'https://genealogies.mvm.ed.ac.uk'
                 let text1 =text0.concat(corpus.split("-")[0]).concat('/headers//')
                 let text2 =text1.concat(file.split("/").pop().split(".")[0])
                 let text3 = text2.concat(".hed")
                 let text4 = text3

                 try {
                     let response = await fetch(text4,requestOptions)
                     data = await response.text();
                     var output = document.getElementById('metadatadiv');
                     data = data.replaceAll("src=\"","src=\"https://genealogies.mvm.ed.ac.uk/omc/headers/")
                     data = data.replaceAll("<document","<b>Document:</b>")
                     data = data.replaceAll("filename=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Filename:</b> ")
                     data = data.replaceAll("publication_date=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Publication Date:</b> ")
                     data = data.replaceAll("capture_date=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Capture Date:</b> ")
                     data = data.replaceAll("format=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Format:</b> ")
                     data = data.replaceAll("article_type=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Article Type:</b> ")
                     data = data.replaceAll("journal=","<br>&nbsp;&nbsp;&nbsp;&nbsp;<b>Journal=</b> ")
                     data = data.replaceAll("<title>","<br><b>Title:</b> ")
                     data = data.replaceAll("<author>"," <br>&nbsp;&nbsp;&nbsp;&nbsp;<b>Author:</b> ")
                     data = data.replaceAll("</author>","")
                     data = data.replaceAll("<organisation","<br><b>Organisation:</b> ")
                     data = data.replaceAll("name=","")
                     data = data.replaceAll("<copyright","<br><b>Copyright: </b>")
                     data = data.replaceAll("<visual_copyright","<br><b>Visual Copyright: </b>")
                     data = data.replaceAll(" status=","<br>&nbsp;&nbsp;&nbsp;&nbsp;<b>Status:</b> ")
                     data = data.replaceAll("<holder>","<br>&nbsp;&nbsp;&nbsp;&nbsp;<b>Holder:</b> ")
                     data = data.replaceAll("<comment>","<br>")
                     data = data.replaceAll("<comments>","<br>&nbsp;&nbsp;&nbsp;&nbsp;<b>Comments:</b> ")
                     data = data.replaceAll("<DOI>","<br><b>doi:</b> ")
                     data = data.replaceAll("<section","<br><br><b>Section:</b> ")
                     data = data.replaceAll(" id=","<br>&nbsp;&nbsp;&nbsp;&nbsp; id: ")
                     data = data.replaceAll("<visual>","<br><b>Visual:</b> ")
                     data = data.replaceAll("</visual>","")
                     data = data.replaceAll("<caption>","<br>&nbsp;&nbsp;&nbsp;&nbsp;<b>Caption:</b> ")
                     data = data.replaceAll("<taxon","<br>&nbsp;&nbsp;&nbsp;&nbsp;<b>Taxon:</b> ")
                     data = data.replaceAll("class=","<br>&nbsp;&nbsp;&nbsp;&nbsp;Class: ")
                     data = data.replaceAll("order=","<br>&nbsp;&nbsp;&nbsp;&nbsp;Order: ")
                     data = data.replaceAll("family=","<br>&nbsp;&nbsp;&nbsp;&nbsp;Family: ")
                     data = data.replaceAll("qualifier=","<br>&nbsp;&nbsp;&nbsp;&nbsp;Qualifier: ")
                     //gok Collection_title:
                     data = data.replaceAll("<collection_title>","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Collection Title: </b> ")
                     data = data.replaceAll("</collection_title>","")
                     data = data.replaceAll("subcorpusid=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Subcorpus id: </b> ")
                     data = data.replaceAll(" language=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Language: </b> ")
                     data = data.replaceAll(" authorship_date=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Authorship Date: </b> ")
                     data = data.replaceAll(" publication_date=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Publication Date: </b> ")
                     data = data.replaceAll(" outlet=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Outlet: </b> ")
                     data = data.replaceAll("internet_outlet=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Internet Outlet: </b> ")



                     data = data.replaceAll("<summary>","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Summary:</b> ")
                     data = data.replaceAll("</summary>","")
                     data = data.replaceAll("<translation","<br><b>Translation:</b> ")
                     data = data.replaceAll("</translation>","")
                     data = data.replaceAll("<translator","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Translator:</b> ")
                     data = data.replaceAll("</translator>","")
                     data = data.replaceAll("<source","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Source:</b> ")
                     data = data.replaceAll(" date=","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Date: </b> ")
                     data = data.replaceAll("<original_title>","<br><b>&nbsp;&nbsp;&nbsp;Original Title: </b> ")
                     data = data.replaceAll("<terms>","<br><b>&nbsp;&nbsp;&nbsp;&nbsp;Terms: </b> ")
                     data = data.replaceAll("</terms>","")
                     data = data.replaceAll("</source>","")


                        //Terms: Not available for commercial purposes
//                      Translation:
                            // status: translation
                            // language: English
                            // Translator:
                                // certainty: certain
                                // Name: Cadenza Academic Translations
                            // Source:
                                // language: French
                                // date: 2013
                                // Original_title: Sur une lacune de la thorie mimtique : labsence du politique dans le systme girardien


                     //ata = data.replaceAll("src=","<br>src: ")
                     data = data.replaceAll("\">","\"")
                     data = data.replaceAll("\'>","\'")
                     data = data.replaceAll(" />","")
                     data = data.replaceAll("\'/>","'")
                     data = data.replaceAll(" >","")
                     data = data.replaceAll("/>","")


                     if(extractsection != "na"){
                         data = data.replaceAll(extractsection,"<b><mark>"+extractsection+"</mark></b> ")
                     }else{
                         data = data.replaceAll("s1","<b><mark>"+"s1"+"</mark></b> ")
                     }
                     // else{
                     //     data = data.replaceAll("s1","<b><mark>"+s1+"</mark></b> ")
                     // }
                     output.innerHTML = data;
                 }
                 catch (e) {
                     return e.message;
                 }
             }

             async function fetchextract(corpus,file,filePos){
                 let text0 = 'https://genealogies.mvm.ed.ac.uk'
                 let text1 =text0.concat(corpus).concat('/extractor?sgml=').concat(document.getElementById("markdownSelect").value).concat('&keyword=')
                 let text2 =text1.concat(currentKeyword.trim())
                 let text3 ='&context='+(document.getElementById("extractnumber").value/2)+'&request=extract&filename='.concat(file.trim()).concat('&position=').concat(filePos)
                 let text4 = text2.concat(text3)

                 try {
                     let response = await fetch(text4,requestOptions)
                     data = await response.text();
                     var output = document.getElementById('extractDiv');
                     output.innerHTML = data;
                 }
                 catch (e) {
                     return e.message;
                 }
             }

             async function updateExtract(){
                 let text0 = 'https://genealogies.mvm.ed.ac.uk'
                 let text1 =text0.concat(document.getElementById("corpusSelect").value).concat('/extractor?sgml=').concat(document.getElementById("markdownSelect").value).concat('&keyword=')
                 let text2 =text1.concat(currentKeyword.trim())
                 let text3 ='&context='+(document.getElementById("extractnumber").value/2)+'&request=extract&filename='.concat(filepath.trim()).concat('&position=').concat(extractpos)
                 let text4 = text2.concat(text3)
                 try {
                     let response = await fetch(text4,requestOptions)
                     data = await response.text();

                     var output = document.getElementById('extractDiv');
                     output.innerHTML = data;
                 }
                 catch (e) {
                     return e.message;
                 }
             }

             function processHeaders(hdrs){
                 var hdrList = hdrs.split("\n")
                 var hdrProps = hdrList[0].split("<section/>");
                 var fileAttrNames = hdrProps[0].split("<sep/>");
                 if(fileAttrNames[fileAttrNames.length -1].trim() ===""){
                     fileAttrNames.pop()
                 }

                 var fileAttributes;
                 if(hdrProps.length>1)
                     sectionAttrNames = hdrProps[1].split("<sep/>");
                 for (let i = 1; i < hdrList.length; i++) {
                     sections = hdrList[i].split("<section/>");
                     for (let j = 0; j < sections.length; j++) {
                         var jsonString = "{";
                         var section = sections[j];
                         if (j == 0) {
                             fileAttributes = section.split("<sep/>");
                             if(fileAttributes[fileAttributes.length -1].trim() ===""){
                                 fileAttributes.pop()
                             }
                             if (sections.length == 1 && fileAttributes.length>1) {
                                 isSectionedHeader = false;
                                 for (let k = 0; k < fileAttributes.length - 1; k++) {
                                     jsonString += fileAttrNames[k] + ":\"" + fileAttributes[k].replaceAll("\"", "").replaceAll("\:", " ").replaceAll("\;", " ").trim() + "\", ";
                                 }
                                 jsonString += "ID" + ":\"" + "ignore" + "\", ";
                                 jsonString += fileAttrNames[fileAttributes.length - 1] + ":\"" + fileAttributes[fileAttributes.length - 1].replaceAll("\"", "").replaceAll("\:", " ").replaceAll("\;", " ").trim() + "\" } ";
                                 var key = fileAttributes[0].trim() + "s1"
                                 headermap[key] = jsonString;
                             }
                         } else {
                             var sectionAttributes = section.split("<sep/>");
                             for (var k = 0; k < fileAttributes.length; k++) {
                                 jsonString += fileAttrNames[k] + ":\"" + fileAttributes[k].replaceAll("\"", "").replaceAll("\:", " ").replaceAll("\;", " ").trim() + "\", ";
                             }
                             for (var l = 0; l < sectionAttrNames.length - 1; l++) {
                                 jsonString += sectionAttrNames[l] + ":\"" + sectionAttributes[l].replaceAll("\"", "").replaceAll("\:", " ").replaceAll("\;", " ").trim() + "\", ";
                             }
                             if(hdrProps.length>1)
                                 jsonString += sectionAttrNames[sectionAttrNames.length - 1] + ":\"" + sectionAttributes[sectionAttrNames.length - 1].replaceAll("\:", " ").replaceAll("\;", " ").trim() + "\" }";
                             var key = fileAttributes[0].trim() + sectionAttributes[0].trim()
                             headermap[key] = jsonString;

                         }
                     }
                 }
                 console.log("Header Download Finished");
                 buildConcMetadata();
             }

             function dataProcess(data,keyword) {
                 // var startTime = performance.now()
                 w2ui['grid'].clear();
                 var countWords = [{}, {}, {}, {}, {}, {}, {}, {}, {}];

                 var countWordsTot = {}
                 var wordOrder = [];
                 var scrolpos = 0;

                 var concJSON;
                 concJSON = JSON.stringify(data.split("\n").map(x => ({text: x})))
                 var concobj = JSON.parse(concJSON);
                 var leftctx = "";
                 var keywordctx = "";
                 var rightctx = "";
                 var fns = "";
                 indextoremove = [];

                 //sorting setup
                 if (sortClick) {
                     concobj = concrdance;
                 }else {
                     for (var i = 1; i < concobj.length - 1; i++) {
                         conc = concobj[i]['text'].split("|")
                         conc[3] = conc.slice(3).join('');

                         var outkey =""
                         if(keyword.includes("*") || keyword.includes("-") || keyword.match(/\".+?\"/g) ){
                             splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("/")[0];
                             outkey = splitKeyword;
                         }else if ( keyword.includes("+") ){
                             splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("/")[0];
                             outkey = splitKeyword.replaceAll(/[.,\/#!$%\^&\*;?:\-{}\"\'=\>_`\\"~\<()]/g, "");
                         }
                         else{
                             splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("-")[0].split("/")[0];
                             outkey = keyword;
                         }
                         var fn = conc[0].split("/")
                         var section = conc[2];
                         fn=fn[fn.length -1];
                         var lftWordtokens =  conc[3].slice(0, 130).trim().toLowerCase().split(' ');
                         var rightWordtokens =  conc[3].slice((130 + splitKeyword.length),conc[3].length).trim().toLowerCase().split(' ');
                         var leftincrement =0;
                         var rightincrement =0;
                         rightWordtokens = rightWordtokens.filter(item => item);
                         lftWordtokens = lftWordtokens.filter(item => item);
                         if(lftWordtokens.length < 7){
                             for (let j = lftWordtokens.length; j < 7; j++) {
                                 lftWordtokens.unshift("zzzz")
                             }
                         }
                         if(rightWordtokens.length < 7){
                             for (let j = rightWordtokens.length+1; j < 7; j++) {
                                 rightWordtokens.push("zzzz")
                             }
                         }
                         if(section== "na"){
                             section ="s1";
                         }

                         if ((removedViaMetafacet.has(fn) || removedViaMetafacet.has(fn + section))) {
                             indextoremove.push(i);
                         }


                         for (let j = 1; j < 7; j++) {
                             var dontSkipleft = 1;
                             var dontSkipright = 1;

                             if (j - 1 + rightincrement < rightWordtokens.length && !(rightWordtokens[j - 1 + rightincrement] ==='')) {
                                 while (j - 1 + rightincrement < rightWordtokens.length && rightWordtokens[j - 1 + rightincrement].replaceAll(/[.,\/#!$%\^&\*;?:\-{}\'=\>_`\\"~\<()]/g, "").length === 0 ) {
                                     rightincrement += 1;
                                     if (j - 1 + rightincrement > rightWordtokens.length ) {
                                         dontSkipright = 0;
                                         break;
                                     }
                                 }
                             }
                             if (lftWordtokens.length - j - leftincrement > 0) {
                                 while (lftWordtokens.length - j - leftincrement > 0 && lftWordtokens[lftWordtokens.length - j - leftincrement].replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "").length === 0 ) {
                                     leftincrement += 1;
                                     if (lftWordtokens.length - j - leftincrement < 0) {
                                         dontSkipleft = 0;
                                         break;
                                     }
                                 }
                             }
                             if (dontSkipleft) {
                                 if (lftWordtokens.length - j - leftincrement >= 0) {
                                     concobj[i]['left' + j] = lftWordtokens[lftWordtokens.length - j - leftincrement].replaceAll(/[.,\/#!$%\^&\*;?:\-{}\\"=_\>`~\<()]/g, "").trim().toLowerCase();
                                 }
                             }
                             if (dontSkipright) {
                                 if (j - 1 + rightincrement < rightWordtokens.length && !(rightWordtokens[j - 1 + rightincrement] === '')) {
                                     concobj[i]['right' + j] = rightWordtokens[j - 1 + rightincrement].replaceAll(/[.,\/#!$%\^&\*;?:\-{}\'=_\>`\\"~\<()]/g, "").trim().toLowerCase();
                                 }
                             }
                         }

                         conc = concobj[i]['text'].split("|")
                         conc[3] = conc.slice(3).join('');
                         concobj[i]['filename'] = fn;
                         concobj[i]['keyword'] = splitKeyword;
                     }

                     for (var l = indextoremove.length - 1; l >= 0; l--)
                         concobj.splice(indextoremove[l], 1);

                 }
                 //(a, b) => a.gsize == b.gsize ? a.glow - b.glow : a.gsize - b.gsize
                 // concobj.sort((a, b) => (a[sortpos] > b[sortpos]) ? 1 : -1)
                 concobj.sort(function (objA, objB) {
                     var sortArguments = [sort1pos, sort2pos, sort3pos]

                     var result = 0;
                     for (var argIndex = 0; argIndex < sortArguments.length && result === 0; argIndex++) {
                         var propertyName = sortArguments[argIndex];
                         result = (objA[propertyName] < objB[propertyName]) ? -1 : (objA[propertyName] > objB[propertyName]) ? 1 : 0;
                     }
                     return result;
                 });
                 //sort
                 concrdance = concobj
                            // var endTime = performance.now()
                            // console.log(`Call to sort conc took ${endTime - startTime} milliseconds`)

                 var firstpos = false;
                 for (var i = 1; i < concobj.length-1; i++){
                     var lineshighlight = false;

                     var color ='white'// i % 2===0 ? "lightgrey": "grey";
                     conc = concobj[i]['text'].split("|")
                     conc[3] = conc.slice(3).join('');
                     var outkey =""
                     if(keyword.includes("*") || keyword.includes("-") || keyword.match(/\".+?\"/g) ){
                         splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("/")[0];
                         outkey = splitKeyword;
                     }else if ( keyword.includes("+") ){
                         splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("/")[0];
                         outkey = splitKeyword.replaceAll(/[.,\/#!$%\^&\*;?\":\-{}\'=\>_`\\"~\<()]/g, "");;
                     }
                     else{
                         splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("-")[0].split("/")[0];
                         outkey = keyword;
                     }
                     var fn = conc[0].split("/")
                     var section = conc[2];
                     var posInFile =conc[1];
                     fn=fn[fn.length -1];
                     var lftWordtokens =  conc[3].slice(0, 130).trim().split(' ');
                     var rightWordtokens =  conc[3].slice((130 + splitKeyword.length),conc[3].length).trim().split(' ');
                     var leftincrement = 0;
                     var rightincrement = 0;
                     rightWordtokens = rightWordtokens.filter(item => item);
                     lftWordtokens = lftWordtokens.filter(item => item);
                     for (let j = 1; j < 7; j++) {
                         var dontSkipleft = 1;
                         var dontSkipright = 1;
                         if (j - 1 + rightincrement < rightWordtokens.length && !(rightWordtokens[j - 1 + rightincrement] ==='')) {
                             while (j - 1 + rightincrement < rightWordtokens.length && rightWordtokens[j - 1 + rightincrement].replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "").length === 0 ) {
                                 rightincrement += 1;
                                 if (j - 1 + rightincrement > rightWordtokens.length ) {
                                     dontSkipright = 0;
                                     break;
                                 }
                             }
                         }
                         if (lftWordtokens.length - j - leftincrement > 0) {
                             while (lftWordtokens.length - j - leftincrement > 0 && lftWordtokens[lftWordtokens.length - j - leftincrement].replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "").length === 0 ) {
                                 leftincrement += 1;
                                 if (lftWordtokens.length - j - leftincrement < 0) {
                                     dontSkipleft = 0;
                                     break;
                                 }
                             }
                         }
                         if (dontSkipleft) {
                             if (lftWordtokens.length - j - leftincrement >= 0) {
                                 if(keyword.includes("+") && ( lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase() === (keyword.split("+")[0]) ) ){
                                     if("left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`~\<()]/g, "")===Mosaicword){
                                          lftWordtokens[lftWordtokens.length - j - leftincrement] = "<b><span style=\"color:purple\" class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + " kwhilight'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span></b>"
                                          if( firstpos === false){
                                               scrolpos = i ;
                                               firstpos = true;
                                          }
                                          lineshighlight = true;
                                     }else{
                                         if(sort1pos ===('left'+j) ){
                                             lftWordtokens[lftWordtokens.length - j - leftincrement] = "<b><span style=\"color:red\" class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + " kwhilight'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span></b>"
                                         }
                                         if(sort2pos ===('left'+j) )
                                             lftWordtokens[lftWordtokens.length - j - leftincrement] = "<b><span style=\"color:#ffc107\" class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + " kwhilight'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span></b>"
                                         if(sort3pos ===('left'+j) ) {
                                             lftWordtokens[lftWordtokens.length - j - leftincrement] = "<b><span style=\"color:#198754\" class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + " kwhilight'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span></b>"
                                         }else{
                                             lftWordtokens[lftWordtokens.length - j - leftincrement] = "<span class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`~\<()]/g, "") + " kwhilight'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span>"
                                         }
                                     }
                                    // lftWordtokens[lftWordtokens.length - j - leftincrement] = "<span class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`~\<()]/g, "") + " kwhilight'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span>"

                                 }else{
                                     if("left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`~\<()]/g, "")===Mosaicword){
                                         lftWordtokens[lftWordtokens.length - j - leftincrement] = "<b><span style=\"color:purple\" class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + "'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span></b>"
                                           if( firstpos === false){
                                               scrolpos = i ;
                                               firstpos = true;
                                          }
                                          lineshighlight =true

                                     }else{
                                          if(sort1pos ===('left'+j) )
                                              lftWordtokens[lftWordtokens.length - j - leftincrement] = "<b><span style=\"color:red\" class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + "'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span></b>"
                                          if(sort2pos ===('left'+j) )
                                               lftWordtokens[lftWordtokens.length - j - leftincrement] = "<b><span style=\"color:#ffc107\" class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + "'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span></b>"
                                          if(sort3pos ===('left'+j) ) {
                                              lftWordtokens[lftWordtokens.length - j - leftincrement] = "<b><span style=\"color:#198754\" class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + "'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span></b>"
                                          }else{
                                              lftWordtokens[lftWordtokens.length - j - leftincrement] = "<span class='left" + j + " left" + j + lftWordtokens[lftWordtokens.length - j - leftincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`~\<()]/g, "") + "'>" + lftWordtokens[lftWordtokens.length - j - leftincrement] + "</span>"
                                          }
                                     }
                                 }
                             }
                         }
                         if (dontSkipright) {
                             if (j - 1 + rightincrement < rightWordtokens.length && !(rightWordtokens[j - 1 + rightincrement] === '')) {
                                 if("right" + j + rightWordtokens[j - 1 + rightincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") === Mosaicword){
                                      if( firstpos === false){
                                               scrolpos = i ;
                                               firstpos = true;
                                          }
                                     lineshighlight = true
                                     rightWordtokens[j - 1 + rightincrement] = " <b><span style=\"color:purple\" class='right" + j + " right" + j + rightWordtokens[j - 1 + rightincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + "'>" + rightWordtokens[j - 1 + rightincrement] + "</span></b>";
                                 }else{
                                     if(sort1pos ===('right'+j) )
                                         rightWordtokens[j - 1 + rightincrement] = "<b><span style=\"color:red\" class='right" + j + " right" + j + rightWordtokens[j - 1 + rightincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + "'>" + rightWordtokens[j - 1 + rightincrement] + "</span></b>";
                                     if(sort2pos ===('right'+j) )
                                         rightWordtokens[j - 1 + rightincrement] = "<b><span style=\"color:#ffc107\" class='right" + j + " right" + j + rightWordtokens[j - 1 + rightincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + "'>" + rightWordtokens[j - 1 + rightincrement] + "</span></b>";
                                     if(sort3pos ===('right'+j) ) {
                                         rightWordtokens[j - 1 + rightincrement] = "<b><span style=\"color:#198754\" class='right" + j + " right" + j + rightWordtokens[j - 1 + rightincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "") + "'>" + rightWordtokens[j - 1 + rightincrement] + "</span></b>";
                                     }else{
                                         rightWordtokens[j - 1 + rightincrement] = "<span class='right" + j + " right" + j + rightWordtokens[j - 1 + rightincrement].toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`~\<()]/g, "") + "'>" + rightWordtokens[j - 1 + rightincrement] + "</span>";
                                     }
                                 }
                             }
                         }
                     }
                     var leftSideHtml = lftWordtokens.join(" ");
                     var rightSideHtml = rightWordtokens.join(" ");
                     rightSideHtml = rightSideHtml.replaceAll('&amp;','&').replaceAll('<visual>','').replaceAll('<caption>', '').replaceAll('image','image id =img'.concat(i)).replaceAll('uri','src');
                     leftSideHtml = leftSideHtml.replaceAll('&amp;','&').replaceAll('<visual>','').replaceAll('<caption>', '').replaceAll('image','image id =img'.concat(i)).replaceAll('uri','src');
                     keywordctxhtml = outkey;

                     if(lftWordtokens.length === 0){
                         leftSideHtml = "<div style='color: transparent;'>*</div>"
                     }
                     if(rightWordtokens.length === 0){
                         rightSideHtml = "<div style='color: transparent;'>*</div>"
                     }
                     if(keywordctxhtml.length === 0){
                         keywordctxhtml  = "*"
                     }


                     if (!removedViaDelete.has(fn+i)) {
                         if(lineshighlight) {
                             if( (toberemovedViaMetafacet.has(fn) || toberemovedViaMetafacet.has(fn + section) )){
                                 grid.records.push({
                                 recid: i,
                                 tablefname: "<div style=\"border:thin solid red;background-color:lightyellow;color:red;\" " + " class=\"" + fn + section + " " + fn + " " + i + "  concord \" " + " onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >  &nbsp  &nbsp " + fn + " &nbsp</div> ",
                                 tableLeftCtx: "<div style=\"border:thin solid red;background-color:lightyellow\" " + " class=\"" + fn + section + " " + fn + " " + i + " concord \" " + " \"  onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + leftSideHtml + ' </div> ',
                                 tablekeyword: "<div style=\"border:thin solid red;background-color:lightyellow\" " + " class=\"" + fn + section + " " + fn + " " + i + " concord \" " + " \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + keywordctxhtml + '</div> ',
                                 tableRightCtx: "<div style=\"border:thin solid red;background-color:lightyellow\" " + " class=\"" + fn + section + " " + fn + " " + i + " concord \" " + " \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + rightSideHtml + ' </div> ',
                                 w2ui: {"style": "background-color: lightyellow"}
                             });
                                }else{
                                 grid.records.push({
                                 recid: i,
                                 tablefname: "<div style=\"background-color:lightyellow;color:red;\" " + " class=\"" + fn + section + " " + fn + " " + i + "  concord \" " + " onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >  &nbsp  &nbsp " + fn + " &nbsp</div> ",
                                 tableLeftCtx: "<div style=\"background-color:lightyellow\" " + " class=\"" + fn + section + " " + fn + " " + i + " concord \" " + " \"  onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + leftSideHtml + ' </div> ',
                                 tablekeyword: "<div style=\"background-color:lightyellow\" " + " class=\"" + fn + section + " " + fn + " " + i + " concord \" " + " \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + keywordctxhtml + '</div> ',
                                 tableRightCtx: "<div style=\"background-color:lightyellow\" " + " class=\"" + fn + section + " " + fn + " " + i + " concord \" " + " \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + rightSideHtml + ' </div> ',
                                 w2ui: {"style": "background-color: lightyellow"}
                             });
                             }

                         }else{
                             if(section === "na")
                                 section ="s1"
                              if( (toberemovedViaMetafacet.has(fn) || toberemovedViaMetafacet.has(fn + section) )){
                                  grid.records.push({
                                     recid: i,
                                     tablefname: "<div" + " class=\"" + fn + section + " " + fn + " " +  i + "  concord \" " + "style=\"border:thin solid red;background-color:" + color + ";color:red; \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >  &nbsp  &nbsp " + fn + " &nbsp</div> ",
                                     tableLeftCtx: "<div style=\"border:thin solid red;\"" + " class=\"" + fn + section + " " + fn + " " +  i + " concord \" " +  " \"  onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + leftSideHtml + ' </div> ',
                                     tablekeyword:  "<div style=\"border:thin solid red;\"" + " class=\"" + fn + section + " " + fn + " " +  i + " concord \" " + " \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + keywordctxhtml + '</div> ',
                                     tableRightCtx:  "<div style=\"border:thin solid red;\"" + " class=\"" + fn + section + " " + fn + " " +  i + " concord \" "  + " \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + rightSideHtml + ' </div> ',
                                 });
                              }else{
                                   grid.records.push({
                                     recid: i,
                                     tablefname: "<div" + " class=\"" + fn + section + " " + fn + " " +  i + "  concord \" " + "style=\"background-color:" + color + ";color:red; \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >  &nbsp  &nbsp " + fn + " &nbsp</div> ",
                                     tableLeftCtx: "<div" + " class=\"" + fn + section + " " + fn + " " +  i + " concord \" " +  " \"  onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + leftSideHtml + ' </div> ',
                                     tablekeyword:  "<div" + " class=\"" + fn + section + " " + fn + " " +  i + " concord \" " + " \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + keywordctxhtml + '</div> ',
                                     tableRightCtx:  "<div" + " class=\"" + fn + section + " " + fn + " " +  i + " concord \" "  + " \" onclick=\"clickConc(\' " + conc[0] + "\',\'" + posInFile + "\',\'" + section + "\',\'" + fn + i + "\' )\" >" + rightSideHtml + ' </div> ',
                                 });
                              }

                         }


                     }

                     // lftWords = conc[3].slice(0, 130).replaceAll(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"").replaceAll(/\s{2,}/g," ");
                     // lftWords = lftWords.toLowerCase()
                     // lftWords = lftWords.split(' ');
                     // // console.log(lftWords.slice(-7))
                     // // console.log(lftWords.slice(-5,-1))
                     // lftWords = lftWords.slice(-5,-1)
                     //
                     // lftWords = lftWords.filter(item => item);
                     // for (var k =0; k < lftWords.length; k++) {
                     //     var val = lftWords[k]
                     //     if(countWords[k][val] === undefined) {
                     //         countWords[k][val] = 1;
                     //         countWordsTot[val] = 1;
                     //     } else {
                     //         countWords[k][val] = countWords[k][val] + 1;
                     //         countWordsTot[val] = countWordsTot[val] + 1;
                     //     }
                     // }
                     //
                     // var rightWords = conc[3].slice((130+ splitKeyword.length),conc[2].length).replaceAll(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"")
                     // rightWords = rightWords.replaceAll(/\s{2,}/g," ");
                     // rightWords = rightWords.toLowerCase()
                     // rightWords = rightWords.split(' ');
                     // rightWords = rightWords.slice(1,5)
                     // rightWords = rightWords.filter(item => item);
                     // console.log(rightWords)
                 //     for (var j =0; j < rightWords.length; j++) {
                 //         var val = rightWords[j]
                 //         if(countWords[j+5][val] === undefined) {
                 //             countWords[j+5][val] = 1;
                 //             countWordsTot[val] = 1;
                 //         } else {
                 //             countWords[j+5][val] = countWords[j+5][val] + 1;
                 //             countWordsTot[val] = countWordsTot[val] + 1;
                 //         }
                 //     }
                 //
                 //
                 //     var val = splitKeyword
                 //     if(countWords[4][val] === undefined) {
                 //         countWords[4][val] = 1;
                 //     } else {
                 //         countWords[4][val] = countWords[4][val] + 1;
                 //     }
                 // }
                 //
                 // for (var l = 0; l < countWords.length; l++) {
                 //     var dict = countWords[l]
                 //     var keys = Object.entries(dict).sort((a,b)=>b[1]-a[1]).map(el=>el[0])
                 //     wordOrder.push(keys)
                 }

                 // var endTime = performance.now()
                 //            console.log(`Call to build conc took ${endTime - startTime} milliseconds`)
                 //var dicttot = countWordsTot
                 //var totkeys = Object.entries(dicttot).sort((a,b)=>b[1]-a[1]).map(el=>el[0])
                 //totkeys = totkeys.slice(0,20)
                 // console.log(wordOrder)
                 // console.log(totkeys)

                //  var div = document.createElement('div');
                //  div.innerHTML = fns;
                //  div.style.textAlign='middle'
                //  div.classList.add('text-nowrap');
                //  //div.style.backgroundColor = color;
                //  // div.classList.add('p2');
                //  document.getElementById("filename").appendChild(div);
                //
                //  var div = document.createElement('div');
                //  div.innerHTML = leftctx;
                //  div.style.textAlign='right'
                //  div.classList.add('text-nowrap');
                //  //div.style.backgroundColor = color;
                //  // div.classList.add('p2');
                //  document.getElementById("leftconc").appendChild(div);
                //
                //  var div = document.createElement('div');
                //  div.innerHTML = keywordctx;
                //  div.style.textAlign='center'
                //  div.style.color = "Blue";
                //  document.getElementById("keyworddisplay").appendChild(div);
                //
                //  var div = document.createElement('div');
                //  div.innerHTML = rightctx;
                //  document.getElementById("rightconc").appendChild(div);
                //  div.classList.add('text-nowrap');
                //
                //  //coloring based on sort position
                //
                // const collection = Array.from(document.getElementsByClassName(sort1pos));
                // collection.forEach(element => {
                //     element.style.color = "red";
                //     element.style.fontWeight = "bold";
                // });
                //
                // const collection2 = Array.from(document.getElementsByClassName(sort2pos));
                // collection2.forEach(element => {
                //     element.style.color = "#ffc107";
                //     element.style.fontWeight = "bold";
                // });
                //
                // const collection3 = Array.from(document.getElementsByClassName(sort3pos));
                // collection2.forEach(element => {
                //     element.style.color = "#198754";
                //     element.style.fontWeight = "bold";
                // });
                //
                //  //recolor metafacetn selections
                //  var items =Array.from(removedViaMetafacet);
                //  items.forEach(element => {
                //      var collection1 = Array.from(document.getElementsByClassName(items[element]));
                //      collection1.forEach(element => {
                //         element.style.border = "thin solid red";
                //      });
                //  });
                 grid.render('#concbox')
                 // w2ui.grid.scrollIntoView(scrolpos);
                  setTimeout(function (d) {
                     grid.scrollIntoView(scrolpos);
                 },100)

                // var endTime = performance.now()
                // console.log(`Call to render conc took ${endTime - startTime} milliseconds`)
             }

             <!-- Mosaic -->
             var mosaicPositions = ["left4","left3","left2","left1","filename","right1","right2","right3","right4"]
             const stopwords = new Set(['i','me','my','myself','we','our','ours','ourselves','you','your','yours','yourself','yourselves','he','him','his','himself','she','her','hers','herself','it','its','itself','they','them','their','theirs','themselves','what','which','who','whom','this','that','these','those','am','is','are','was','were','be','been','being','have','has','had','having','do','does','did','doing','a','an','the','and','but','if','or','because','as','until','while','of','at','by','for','with','about','against','between','into','through','during','before','after','above','below','to','from','up','down','in','out','on','off','over','under','again','further','then','once','here','there','when','where','why','how','all','any','both','each','few','more','most','other','some','such','no','nor','not','only','own','same','so','than','too','very','s','t','can','will','just','don','should','now']);

             async function dataProcessMosaic(data,keyword){
                 var startTime = performance.now()
                 setTimeout(function (d) {
                     $('concbox').scrollLeft(250);
                 },100)
                 document.getElementById("chart").innerHTML = '';

                 var countWords = [{},{},{},{},{},{},{},{},{}];
                 var countWordsTot ={}
                 var wordOrder = [];
                 var  concJSON;
                 concJSON = JSON.stringify(data.split("\n").map(x => ({text: x})))
                 var concobj = JSON.parse(concJSON );
                 for (let l = indextoremove.length -1; l >= 0; l--)
                     concobj.splice(indextoremove[l],1);

                 var leftctx = "";
                 var keywordctx ="";
                 var rightctx = "";

                 for (var i = 1; i < concobj.length-1; i++) {
                     var conc = concobj[i]['text'].split("|")
                     conc[3] = conc.slice(3).join('');
                     var fn = conc[0].split("/")
                     fn=fn[fn.length -1];
                     concobj[i]['filename'] = fn;
                 }
                var endTime = performance.now()
                 // console.log(`Call to build mosaic starttook ${endTime - startTime} milliseconds`)
                 concobj.sort(function (objA, objB) {
                     var sortArguments = [sort1pos, sort2pos, sort3pos]

                     var result = 0;
                     for (var argIndex = 0; argIndex < sortArguments.length && result === 0; argIndex++) {
                         var propertyName = sortArguments[argIndex];
                         result = (objA[propertyName] < objB[propertyName]) ? -1 : (objA[propertyName] > objB[propertyName]) ? 1 : 0;
                     }
                     return result;
                 });

                 // var endTime = performance.now()
                 // console.log(`Call to sort mosaic took ${endTime - startTime} milliseconds`)


                 for (var i = 1; i < concobj.length-1; i++){
                     conc = concobj[i]['text'].split("|")
                     conc[3] = conc.slice(3).join('');
                     var fn = concobj[i]['filename']
                     if (!removedViaDelete.has(fn+i)) {
                         leftctx += conc[3].slice(0, 130) + '<br> ';
                         keywordctx += conc[3].slice(130, (130 + keyword.length)) + '<br> ';
                         rightctx += conc[3].slice((130 + keyword.length), conc[3].length) + '<br> ';

                         var lftWords = conc[3].slice(0, 130).replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "").replaceAll(/\s{2,}/g, " ");
                         lftWords = lftWords.toLowerCase().trim();
                         lftWords = lftWords.split(' ');
                         // console.log(lftWords.slice(-7))
                         // console.log(lftWords.slice(-5,-1))
                         lftWords = lftWords.slice(-4)
                         for (var k = 0; k < lftWords.length; k++) {
                             var val = lftWords[k]
                             if (countWords[k][val] === undefined) {
                                 countWords[k][val] = 1;
                                 countWordsTot[val] = 1;
                             } else {
                                 countWords[k][val] = countWords[k][val] + 1;
                                 countWordsTot[val] = countWordsTot[val] + 1;
                             }
                         }

                         if(keyword.includes("*") || keyword.includes("-") || keyword.match(/\".+?\"/g) ){
                             splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("/")[0];
                         }else if ( keyword.includes("+") ){
                             splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("/")[0];
                         }
                         else{
                             splitKeyword = conc[3].slice(130 , conc[3].length).trim().split(' ')[0].split("-")[0].split("/")[0];

                         }

                         var rightWords = conc[3].slice((130+ splitKeyword.length),conc[3].length).replaceAll(/[.,\/#!$%\^&\*;?\':\-{}\\"=_\>`~\<()]/g, "")
                         //var rightWords = conc[3].slice((130 + keyword.length), conc[3].length).replaceAll(/[.,\/#!\<\>$%\^&\*;:{}?=_`~()]/g, "")
                         rightWords = rightWords.replaceAll(/\s{2,}/g, " ");
                         rightWords = rightWords.toLowerCase()
                         rightWords = rightWords.split(' ');
                         rightWords = rightWords.slice(1, 5)

                         for (var j = 0; j < rightWords.length; j++) {
                             var val = rightWords[j]
                             if (countWords[j + 5][val] === undefined) {
                                 countWords[j + 5][val] = 1;
                                 countWordsTot[val] = 1;
                             } else {
                                 countWords[j + 5][val] = countWords[j + 5][val] + 1;
                                 countWordsTot[val] = countWordsTot[val] + 1;
                             }
                         }


                         var val = splitKeyword.toLowerCase().replaceAll(/[.,\/#!$%\^&\*;?\':\-{}=_\>`\\"~\<()]/g, "")
                         if (countWords[4][val] === undefined) {
                             countWords[4][val] = 1;
                         } else {
                             countWords[4][val] = countWords[4][val] + 1;
                         }
                     }
                 }
                 // var endTime = performance.now()
                 // console.log(`Call to count words took ${endTime - startTime} milliseconds`)

                 for (var l = 0; l < countWords.length; l++) {
                     var dict = countWords[l]
                     var keys = Object.entries(dict).sort((a,b)=>b[1]-a[1]).map(el=>el[0])
                     wordOrder.push(keys)
                 }
                 //  var endTime = performance.now()
                 // console.log(`Call to map keys took ${endTime - startTime} milliseconds`)

                 var dicttot = countWordsTot

                 //this is for doing stuff with the top n words in the mosaic
                 var totkeys = Object.entries(dicttot).sort((a,b)=>b[1]-a[1]).map(el=>el[0])
                 totkeys = totkeys.slice(0,20)

                 var Mwidth = 1800
                 var colwidth = 200

                 var margin = {top: 50, right: 45, bottom: 80, left: 45}, width = (Mwidth) , height = 800 ;

                 svg = d3.select("#chart").classed("svg-container", true)
                         .append("svg")
                 // Responsive SVG needs these 2 attributes and no width and height attr.
                         .attr("preserveAspectRatio", "xMinYMin meet")
                 //      .attr("preserveAspectRatio", "none")
                 //      .attr("width", "100%")
                         .attr("height", "100%")
                         .attr("viewBox", "0 0 1900 1050")
                 // Class to make it responsive.
                         .classed("svg-content-responsive", true)
                 // Fill with a rectangle for visualization.
                         .append("g")
                         .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                 // d3.select('body')
                 //   .append('div')
                 //   .attr('id', 'tooltip')
                 //   .attr('style', 'position: absolute; opacity: 0;');

                 //Draw rectangles
                 var position = 0;

                 //var color = d3.scale.category20();
                 var color =["#ffcc99","#99bbff"]

                 var frequency_min = (nonlinear($("#slider-range").slider("values", 0)) * 1.0)/100;
                 var frequency_max = (nonlinear($("#slider-range").slider("values", 1)) * 1.0)/100;

                 // used to calculate total of columns
                 const sumValues = obj => Object.values(obj).reduce((a, b) => a + b, 0);

                 var max = concobj.length-2;
                 document.getElementById("linesreturned").innerHTML ="Lines returned : "+ max;

                 var selectedRect;
                 // var endTime = performance.now()
                 // console.log(`Call to box heigths took ${endTime - startTime} milliseconds`)
                 for (var col = 0; col < countWords.length; col++) {

                     var heigthUsed = 0;
                     var order = wordOrder[col]
                     var currentCol = countWords[col]
                     //remove values under min frequency threshold

                     for (var word in currentCol) {
                         if ((currentCol[word] * 1.0) / max <= frequency_min) {
                             if (col != 4)
                                 delete currentCol[word];
                         }
                         if ((currentCol[word] * 1.0) / max > frequency_max) {
                             if (col != 4)
                                 delete currentCol[word];
                         }
                         if (filterStopwords) {
                             //stopword removal
                             if (stopwords.has(word)) {
                                 if (col != 4)
                                     delete currentCol[word];
                             }
                         }
                     }

                     var colMax = sumValues(countWords[col])

                     for (var word = 0; word < order.length; word++) {
                         var wordstr = order[word]
                         if( wordstr in currentCol) {
                             var boxH = currentCol[wordstr]
                             var boxWidth =((col + 1) * (colwidth) - (col * colwidth));
                             var boxHeigth = 1000 * ((1.0 * boxH) / colMax);
                             var rect = svg.append('rect')
                                           .attrs({
                                               x: col * colwidth,
                                               y: heigthUsed,
                                               width: boxWidth,
                                               height: boxHeigth
                                           })
                                           .attr("id", "s" + col.toString() + wordstr)
                                           .attr("column", col )
                                           .attr("word", wordstr )
                                           .attr("count", boxH )
                                           .attr("freq", Math.round( 10000 * ((1.0 * boxH) / max)) /100.0)
                                           .attr("memcol", function (d) {
                                               return col === 4 ? 'steelblue' : totkeys.includes(wordstr) ? color[0+((word + ((col+1)%2)) % 2)] : color[0+((word + ((col+1)%2)) % 2)];
                                           }).style("stroke", 'black')
                                           .style("stroke-width", .1)
                                           .style("fill", function (d) {
                                               return col === 4 ? 'steelblue' : totkeys.includes(wordstr) ? color[0+((word + ((col+1)%2)) % 2)] : color[0+((word + ((col+1)%2)) % 2)];
                                           }).on("click", async function(d){
                                                    d3.select(selectedRect).style("fill", d3.select(this).attr("memcol"));

                                                    d3.select(selectedRect).style("stroke", 'black')
                                                       .style("stroke-width", .1);

                                                   d3.select(this).style("stroke", 'black')
                                                       .style("stroke-width", 2);
                                                   d3.select(this).style("fill", "white");
                                                   selectedRect = this;

                                                   let concordancebox = document.getElementById("concbox")
                                                   concordancebox.innerHTML = "<div class=\"spinner-border text-success d-flex align-items-center justify-content-center\" role=\"status\">" +
                                                       "  <span class=\"visually-hidden\">Loading...</span>" +
                                                       "</div>";
                                                   concordancebox.style.display = 'none';
                                                   concordancebox.style.display = 'block';

                                                   // let fnfn = document.getElementById("filename")
                                                   // fnfn.innerHTML = "<br><br><h2>Loading Concordance          </h2>";
                                                   // fnfn.parentElement.style.display = 'none';
                                                   // fnfn.parentElement.style.display = 'block';
                                                   // let lctx = document.getElementById("leftconc")
                                                   // lctx.innerHTML = "";
                                                   // let rttx = document.getElementById("rightconc")
                                                   // rttx.innerHTML = "";
                                                  setTimeout(await ProcessMosaicClick(mosaicPositions[d3.select(this).attr("column")],mosaicPositions[d3.select(this).attr("column")]+d3.select(this).attr("word")), 10);

                                           })
                                           .on("mousemove", function (d) {
                                               tooltip.style("left", d3.event.pageX - 50 + "px")
                                                      .style("top", d3.event.pageY - 70 + "px")
                                                      .style("display", "inline-block")
                                                      .html("Keyword : " + d3.select(this).attr("word")+"<br>"
                                                           +"Count : " + d3.select(this).attr("count")+"  "
                                                           +"Frequency : " + d3.select(this).attr("freq")+"<br>");
                                           })
    		                           .on("mouseout", function(d){ tooltip.style("display", "none");});;

                             // .style("stroke-color", 'black')
                             // .style("stroke-width", 1)
                             var adjust =1;
                             if(wordstr.length>8)
                                 adjust = .9
                             if(boxH/colMax>.49)
                                 adjust =0.7

                             svg.append("text")
                                          .attr("pointer-events", "none")
                                          .attr("x", function (d) {
                                              return (col * colwidth) + 95;
                                          })
                                          .attr("y", function (d) {

                                              if(boxHeigth>12){
                                                  var thisWidth = this.getComputedTextLength()
                                                  scale = (boxWidth/thisWidth)
                                                  scale = Math.min(scale,boxHeigth);
                                              }else{
                                                  scale =  boxHeigth/1.5;
                                              }
                                              if(boxHeigth>700)
                                                  scale =0;

                                              return heigthUsed + ((1000 * ((1.0 * boxH) / colMax)) / 2)  +scale/4 ;
                                          })
                                          .attr("boxH", function (d) {
                                              return boxH;
                                          })
                                          .attr("id", "st" + col.toString() + wordstr)
                                          .style("text-anchor", "middle")
                                          .style("font-size", "1px")
                             // .style("font-size", function (d) {
                             //   return Math.round(col === 4 ? 24 : wordstr.length>5 ? (adjust * 120 * ((1.0 * boxH) / colMax)) : (adjust* 190 * ((1.0 * boxH) / colMax)));
                             // })
                                          .attr("opacity", function (d) {
                                              return (1000 * ((1.0 * boxH) / colMax)) > 12 ? 1 : 0;
                                          })
                                          .style("fill", "black")
                                          .text(wordstr)
                                          .style("font-size", function(d) {
                                              if(boxHeigth>12){
                                                  var thisWidth = this.getComputedTextLength()
                                                  scale = (boxWidth/thisWidth)
                                                  scale = Math.min(scale,boxHeigth);
                                              }else{
                                                  scale =  boxHeigth/1.5;
                                              }
                                              return scale -2 + "px"; });
                             heigthUsed += 1000 * ((1.0 * boxH) / colMax);
                         }
                     }
                 }
                 // var endTime = performance.now()
                 // console.log(`Call to end mosaic took ${endTime - startTime} milliseconds`)
             }

             //metafacet
             function buildConcMetadata(){
                 document.getElementById("metatextbox").innerHTML ="";

                 toRemoveAtts = new Set();
                 attrSelected ="Format";

                 json = "[";
                 for (let i = 1; i < concrdance.length ; i++) {

                     var next = concrdance[i];
                     var attributes = next.text.split("|")
                     if(attributes.length<=1)
                         continue;
                     var fn =  attributes[0].split(".")[0].split("/");
                     fn = fn[fn.length-1]
                     var section = "s1"
                     if(isSectionedHeader){
                         section = attributes[2];
                     }
                     if (!removedViaDelete.has(fn+".xml"+i)) {
                         var key = fn + section;
                         json += headermap[key] + ",";
                     }
                 }
                 json = json.replaceAll(/(^,)|(,$)/g, "");
                 json+="]"
                 let result = Function("return " + json)();
                 loadData(result);
             }

             var metasvg,
                 defs,
                 gBrush,
                 brush,
                 main_xScale,
                 mini_xScale,
                 main_yScale,
                 mini_yScale,
                 main_yZoom,
                 main_xAxis,
                 main_yAxis,
                 mini_width,
                 textScale,
                 numConclines,
                 dropdown,
                 initdata;


             var removedKeys = new Set();
             var shouldSort = false;

             var toRemoveAtts = new Set();
             var removeAtts = new Set();
             var attrSelected ="Format";

             //stores the reordered data so we can extraxt metadata assoiated with attribute keys
             var nested;

             dropdown = d3.select("#chart2").append("div")
                          .attr("id","drop")
                          .attr("align","centre");

             //Added only for the mouse wheel
             var zoomer = d3.behavior.zoom()
                            .on("zoom", null);

             var main_margin = {top: 10, right: 10, bottom: 30, left: 190},
                 main_width = 700 - main_margin.left - main_margin.right,
                 main_height = 450 - main_margin.top - main_margin.bottom;

             var mini_margin = {top: 10, right: 10, bottom: 30, left: 10},
                 mini_height = 450 - mini_margin.top - mini_margin.bottom;
             mini_width = 100 - mini_margin.left - mini_margin.right;
             // console.log( main_width + main_margin.left + main_margin.right + mini_width + mini_margin.left + mini_margin.right)
             //     console.log( main_height + main_margin.top + main_margin.bottom)
             metasvg = d3.select("#chart2").append("svg")
                         .attr("class", "svgWrapper")
                         .attr("id", "metachart")
                         .attr("width", main_width + main_margin.left + main_margin.right + mini_width + mini_margin.left + mini_margin.right)
                         .attr("height", main_height + main_margin.top + main_margin.bottom)
                         .attr("preserveAspectRatio", "xMinYMin meet")
             //      .attr("preserveAspectRatio", "none")
             //      .attr("width", "100%")
                         .attr("height", "100%")
                         .attr("viewBox", "0 0 800 450")
                         .call(zoomer)
                         .on("wheel.zoom", scroll)
             //.on("mousewheel.zoom", scroll)
             //.on("DOMMouseScroll.zoom", scroll)
             //.on("MozMousePixelScroll.zoom", scroll)
             //Is this needed?
                         .on("mousedown.zoom", null)
                         .on("touchstart.zoom", null)
                         .on("touchmove.zoom", null)
                         .on("touchend.zoom", null);


             var selector = d3.select("#drop")
                              .append("select")
                              .attr("id","dropdown")
                              .on("change", function(d){
                                  selection = document.getElementById("dropdown");
                                  metasvg.selectAll("*").remove();
                                  //d3.select("#dropdown").remove();
                                  attrSelected = selection.value;
                                  dataProcessMetafacet(selection.value);
                              });

             var checkbox = d3.select("#drop")
                              .append("input")
                              .attr("type","checkbox")
                              .attr("id","cb")
                              .attr("name","cb")
                              .on("change", function(d){
                                  if(shouldSort ===true)
                                      shouldSort = false
                                  else
                                      shouldSort = true;
                                  selection = document.getElementById("dropdown");
                                  dataProcessMetafacet(selection.value);

                              });
             d3.select("#drop")
               .append("label")
               .attr("for","cb")
               .text("Sort by frequency");


             //    var elements = ["Filename","Title", "Collection_Title", "Editor", "Author", "Publication_Date", "Authorship_Date", "Translator",
             //        "Source_Date", "Source_Filename", "Source_Language", "Original_Title" ,"Outlet", "Internet_Outlet","Format"];
             var elements = ["Filename","Title", "Collection_Title", "Editor", "Author"];


             var tooltip = d3.select("body").append("div").attr("class", "toolTip");



             function init() {

                 /////////////////////////////////////////////////////////////
                 ///////////////// Set-up SVG and wrappers ///////////////////
                 /////////////////////////////////////////////////////////////

                 selector.selectAll("option").remove();
                 selector.selectAll("option")
                         .data(elements)
                         .enter().append("option")
                         .attr("value", function(d){
                             return d;
                         })
                         .text(function(d){
                             return d;
                         });
                 selector.property('value', attrSelected);

                 var mainGroup = metasvg.append("g")
                                        .attr("class","mainGroupWrapper")
                                        .attr("transform","translate(" + main_margin.left + "," + main_margin.top + ")")
                                        .append("g") //another one for the clip path - due to not wanting to clip the labels
                                        .attr("clip-path", "url(#clip)")
                                        .style("clip-path", "url(#clip)")
                                        .attr("class","mainGroup")


                 var miniGroup = metasvg.append("g")
                                        .attr("class","miniGroup")
                                        .attr("transform","translate(" + (main_margin.left + main_width + main_margin.right + mini_margin.left) + "," + mini_margin.top + ")");

                 var brushGroup = metasvg.append("g")
                                         .attr("class","brushGroup")
                                         .attr("transform","translate(" + (main_margin.left + main_width + main_margin.right + mini_margin.left) + "," + mini_margin.top + ")");

                 /////////////////////////////////////////////////////////////
                 ////////////////////// Initiate scales //////////////////////
                 /////////////////////////////////////////////////////////////

                 main_xScale = d3.scale.linear().range([0, main_width]);
                 mini_xScale = d3.scale.linear().range([0, mini_width]);

                 main_yScale = d3.scale.ordinal().rangeBands([0, main_height], 0.4, 0);
                 mini_yScale = d3.scale.ordinal().rangeBands([0, mini_height], 0.4, 0);

                 //Based on the idea from: http://stackoverflow.com/questions/21485339/d3-brushing-on-grouped-bar-chart
                 main_yZoom = d3.scale.linear()
                                .range([0, main_height])
                                .domain([0, main_height]);

                 //Create x axis object
                 main_xAxis = d3.svg.axis()
                                .scale(main_xScale)
                                .orient("bottom")
                                .ticks(4)
                 //.tickSize(0)
                                .outerTickSize(0);

                 //Add group for the x axis
                 d3.select(".mainGroupWrapper").append("g")
                   .attr("class", "x axis")
                   .attr("transform", "translate(" + 0 + "," + (main_height + 5) + ")");

                 //Create y axis object
                 main_yAxis = d3.svg.axis()
                                .scale(main_yScale)
                                .orient("left")
                                .tickSize(0)
                                .outerTickSize(0);

                 //Add group for the y axis
                 mainGroup.append("g")
                          .attr("class", "y axis")
                          .attr("transform", "translate(-5,0)");

                 /////////////////////////////////////////////////////////////
                 /////////////////////// Update scales ///////////////////////
                 /////////////////////////////////////////////////////////////

                 //Update the scales
                 main_xScale.domain([0, d3.max(data, function(d) { return d.values; })]);
                 mini_xScale.domain([0, d3.max(data, function(d) { return d.values; })]);
                 main_yScale.domain(data.map(function(d) { return d.key; }));
                 mini_yScale.domain(data.map(function(d) { return d.key; }));

                 //Create the visual part of the y axis
                 d3.select(".mainGroup").select(".y.axis").call(main_yAxis);
                 d3.select(".mainGroupWrapper").select(".x.axis").call(main_xAxis);




                 /////////////////////////////////////////////////////////////
                 ///////////////////// Label axis scales /////////////////////
                 /////////////////////////////////////////////////////////////

                 textScale = d3.scale.linear()
                               .domain([15,50])
                               .range([12,6])
                               .clamp(true);

                 /////////////////////////////////////////////////////////////
                 ///////////////////////// Create brush //////////////////////
                 /////////////////////////////////////////////////////////////

                 //What should the first extent of the brush become - a bit arbitrary this
                 var brushExtent = Math.max( 0,  Math.floor(data.length*.7)  );

                 brush = d3.svg.brush()
                           .y(mini_yScale)
                           .extent([mini_yScale(data[0].key), mini_height])
                           .on("brush", brushmove)
                 //.on("brushend", brushend);

                 //Set up the visual part of the brush
                 gBrush = d3.select(".brushGroup").append("g")
                            .attr("class", "brush")
                            .call(brush);

                 gBrush.selectAll(".resize")
                       .append("line")
                       .attr("x2", mini_width);

                 gBrush.selectAll(".resize")
                       .append("path")
                       .attr("d", d3.svg.symbol().type("triangle-up").size(20))
                       .attr("transform", function(d,i) {
                           return i ? "translate(" + (mini_width/2) + "," + 4 + ") rotate(180)" : "translate(" + (mini_width/2) + "," + -4 + ") rotate(0)";
                       });

                 gBrush.selectAll("rect")
                       .attr("width", mini_width);

                 //On a click recenter the brush window
                 gBrush.select(".background")
                       .on("mousedown.brush", brushcenter)
                       .on("touchstart.brush", brushcenter);

                 ///////////////////////////////////////////////////////////////////////////
                 /////////////////// Create a rainbow gradient - for fun ///////////////////
                 ///////////////////////////////////////////////////////////////////////////

                 defs = metasvg.append("defs")

                 //Create two separate gradients for the main and mini bar
                 createGradient("gradient-rainbow-main", "60%");
                 createGradient("gradient-rainbow-mini", "13%");

                 //Add the clip path for the main bar chart
                 defs.append("clipPath")
                     .attr("id", "clip")
                     .append("rect")
	             .attr("x", -main_margin.left)
                     .attr("width", main_width + main_margin.left)
                     .attr("height", main_height);

                 /////////////////////////////////////////////////////////////
                 /////////////// Set-up the mini bar chart ///////////////////
                 /////////////////////////////////////////////////////////////

                 //The mini brushable bar
                 //DATA JOIN
                 var mini_bar = d3.select(".miniGroup").selectAll(".bar")
                                  .data(data, function(d) { return d.key; });

                 //UDPATE
                 mini_bar
                     .attr("width", function(d) { return mini_xScale(d.values); })
                     .attr("y", function(d,i) { return mini_yScale(d.key); })
                     .attr("height", mini_yScale.rangeBand());

                 //ENTER
                 mini_bar.enter().append("rect")
                         .attr("class", "bar")
                         .attr("x", 0)
                         .attr("width", function(d) { return mini_xScale(d.values); })
                         .attr("y", function(d,i) { return mini_yScale(d.key); })
                         .attr("height", mini_yScale.rangeBand())
                         .style("fill", "url(#gradient-rainbow-mini)");

                 //EXIT
                 mini_bar.exit()
                         .remove();

                 //Start the brush
                 gBrush.call(brush.event);
                 brushmove();


                 var dragstartPos;
                 function dragStart() {
                     dragstartPos = d3.mouse(this);
                 }

                 function dragMove() {
                     var p = d3.mouse(this);
                     d3.select(".mainGroup").selectAll(".bar")
                       .each(function(b) {
                           var shouldRemove = false;
                           var yval = +d3.select(this).attr('y')
                           var shouldremove = false;
                           if (dragstartPos[0] < main_width + main_margin.left + main_margin.right){
                               if (p[1] > dragstartPos[1])
                                   shouldremove = yval > dragstartPos[1] && yval < p[1];
                               if (p[1] < dragstartPos[1])
                                   shouldremove = yval < dragstartPos[1] && yval > p[1];
                               if(shouldremove ){
                                   var currentColor =  "red" ;
                                   var opacity =  0.3;
                                   d3.select(this).style("fill", currentColor);
                                   d3.select(this).style("opacity", opacity);
                               }
                           }
                       });
                 }

                 function dragEnd() {
                     var p = d3.mouse(this);
                     d3.select(".mainGroup").selectAll(".bar")
                       .each(function(b) {
                           var yval = +d3.select(this).attr('y')
                           var shouldremove = false;
                           if (dragstartPos[0] < main_width + main_margin.left + main_margin.right){
                               if (p[1] > dragstartPos[1])
                                   shouldremove = yval > dragstartPos[1] && yval < p[1];
                               if (p[1] < dragstartPos[1])
                                   shouldremove = yval < dragstartPos[1] && yval > p[1];
                               if(shouldremove ){
                                   var currentColor = "red" ;
                                   var opacity =  0.3 ;
                                   d3.select(this).style("fill", currentColor);
                                   d3.select(this).style("opacity", opacity);
                                   remove(b.key);
                               }
                           }

                       });
                     // vec.redisplay();
                 }


                 // var dragBehavior = d3.behavior.drag()
                 //                      .on("dragstart", dragStart)
                 //                      .on("drag", dragMove)
                 //                      .on("dragend", dragEnd);
                 //
                 // metasvg.call(dragBehavior);

             }//init

             //Function runs on a brush move - to update the big bar chart
             function update() {

                 /////////////////////////////////////////////////////////////
                 ////////// Update the bars of the main bar chart ////////////
                 /////////////////////////////////////////////////////////////

                 //DATA JOIN
                 var bar = d3.select(".mainGroup").selectAll(".bar")
                             .data(data, function(d) { return d.key; });

                 //UPDATE
                 bar.attr("x", 0)
                     .attr("width", function(d) { return main_xScale(d.values); })
                     .attr("y", function(d,i) { return main_yScale(d.key); })
                     .attr("height", main_yScale.rangeBand())
                     .on("click", function(d) {

                         if ( d3.event.shiftKey) {
                             d3.select(".mainGroup").selectAll(".bar")
                               .each(function(b) {
                                   var shouldRemove = true;
                                   if(b.key === d.key)
                                       shouldRemove = false;
                                   var currentColor =  shouldRemove ?  "red":"url(#gradient-rainbow-main)" ;
                                   var opacity =  shouldRemove ? 1.0 : 1.0;
                                   d3.select(this).style("fill", currentColor);
                                   d3.select(this).style("opacity", opacity);
                                   shouldRemove ? remove(b.key): add(b.key); ;
                               });
                             dataProcess(currentData,currentKeyword);

                         }
                         else{
                             var removed = false;
                             var allRemoved = true;
                             nested.map(function(m) {
                                 if(m.key === d.key || (d.key === "N/A" && m.key.trim() === "")){
                                     m.values.map(function(v) {
                                         if(removedKeys.has(v.Filename+v.ID)){
                                            removed = true;
                                            for (var key in v) {
                                                if(toRemoveAtts.has(v[key]) )
                                                    toRemoveAtts.delete(v[key])
                                            }
                                        }else{
                                             allRemoved = false;
                                         }
                                     });
                                 };
                             });
                             var colChoice = allRemoved ?   "url(#gradient-rainbow-main)" :"red";
                             var currentColor =  removed ? "url(#gradient-rainbow-main)" : colChoice;
                             var opacity =  allRemoved ? 1.0 : 1.0;
                             d3.select(this).style("fill", currentColor);
                             d3.select(this).style("opacity", opacity);
                             if(d.key === "N/A"){
                                 removed ? add("") : remove("");
                             }else{
                                removed ? add(d.key) : remove(d.key);
                             }

                             dataProcess(currentData,currentKeyword);
                         }
                         // dataProcess(currentData,currentKeyword);
                         // vec.redisplay();
                         refreshBars()
                     })
                     .on("mousemove", function(d){
                         tooltip
                             .style("left", d3.event.pageX - 50 + "px")
                             .style("top", d3.event.pageY - 70 + "px")
                             .style("display", "inline-block")
                             .html("Number of lines with attribute "+(d.key) +" : "+ (d.values)
                                  +"<br>Concordance Size : " +numConclines);
                     })
    		     .on("mouseout", function(d){ tooltip.style("display", "none");});;

                 // ENTER
                 function refreshBars() {
                     bar.enter().append("rect")
                    .attr("class", "bar")
                    .style("fill",function(d) {
                        var removed = false;
                        var allRemoved = true;
                        var numremoved = 0;
                        nested.map(function(m) {
                            if(m.key === d.key){
                                m.values.map(function(v) { if(removedKeys.has(v.Filename+v.ID)){
                                    removed = true;
                                }else{
                                    allRemoved = false;
                                }});
                            };
                        });
                        var colChoice = allRemoved ? "red" : "url(#gradient-rainbow-main)";
                        var col = removed ? colChoice : "url(#gradient-rainbow-main)";
                        if(toRemoveAtts.has(d.key))
                            col ="red"
                        return col;
                    })
                    .style("opacity", function(d) {
                        var removed = false;
                        nested.map(function(m) {
                            if(m.key === d.key){
                                m.values.map(function(v) { if(removedKeys.has(v.Filename+v.ID)){
                                    removed = true;
                                } });
                            };
                        });
                        var opacity =  removed ? 1.0 : 1.0;
                        return opacity;
                    })
                    .attr("x", 0)
                    .attr("width", function(d) { return main_xScale(d.values); })
                    .attr("y", function(d,i) { return main_yScale(d.key); })
                    .attr("height", main_yScale.rangeBand());
                 }
                refreshBars()

                 //EXIT
                 bar.exit()
                    .remove();
             }//update

             /////////////////////////////////////////////////////////////
             ////////////////////// Brush functions //////////////////////
             /////////////////////////////////////////////////////////////

             //First function that runs on a brush move
             function brushmove() {

                 var extent = brush.extent();

                 //Reset the part that is visible on the big chart
                 var originalRange = main_yZoom.range();
                 main_yZoom.domain( extent );

                 /////////////////////////////////////////////////////////////
                 ///////////////////// Update the axis ///////////////////////
                 /////////////////////////////////////////////////////////////

                 //Update the domain of the x & y scale of the big bar chart
                 main_yScale.domain(data.map(function(d) { return d.key; }));
                 main_yScale.rangeBands( [ main_yZoom(originalRange[0]), main_yZoom(originalRange[1]) ], 0.4, 0);

                 //Update the y axis of the big chart
                 d3.select(".mainGroup")
                   .select(".y.axis")
                   .call(main_yAxis)
                   .selectAll(".y.axis text")
                   .call(wrap, main_yScale.rangeBand());

                 /////////////////////////////////////////////////////////////
                 /////////////// Update the mini bar fills ///////////////////
                 /////////////////////////////////////////////////////////////

                 //Update the colors within the mini bar chart
                 var selected = mini_yScale.domain()
                                           .filter(function(d) { return (extent[0] - mini_yScale.rangeBand() + 1e-2 <= mini_yScale(d)) && (mini_yScale(d) <= extent[1] - 1e-2); });
                 //Update the colors of the mini chart - Make everything outside the brush grey
                 d3.select(".miniGroup").selectAll(".bar")
                   .style("fill", function(d, i) { return selected.indexOf(d.key) > -1 ? "url(#gradient-rainbow-mini)" : "#e0e0e0"; });

                 //Update the label size
                 d3.selectAll(".y.axis text")
                   .style("font-size", textScale(selected.length));

                 //Update the big bar chart
                 update();

             }//brushmove

             /////////////////////////////////////////////////////////////
             ////////////////////// Click functions //////////////////////
             /////////////////////////////////////////////////////////////

             //Based on http://bl.ocks.org/mbostock/6498000
             //What to do when the user clicks on another location along the brushable bar chart
             function brushcenter() {
                 var target = d3.event.target,
                     extent = brush.extent(),
                     size = extent[1] - extent[0],
                     range = mini_yScale.range(),
                     y0 = d3.min(range) + size / 2,
                     y1 = d3.max(range) + mini_yScale.rangeBand() - size / 2,
                     center = Math.max( y0, Math.min( y1, d3.mouse(target)[1] ) );

                 d3.event.stopPropagation();

                 gBrush
                     .call(brush.extent([center - size / 2, center + size / 2]))
                     .call(brush.event);

             }//brushcenter

             /////////////////////////////////////////////////////////////
             ///////////////////// Scroll functions //////////////////////
             /////////////////////////////////////////////////////////////

             function scroll() {

                 //Mouse scroll on the mini chart
                 var extent = brush.extent(),
                     size = extent[1] - extent[0],
                     range = mini_yScale.range(),
                     y0 = d3.min(range),
                     y1 = d3.max(range) + mini_yScale.rangeBand(),
                     dy = d3.event.deltaY,
                     topSection;

                 if ( extent[0] - dy < y0 ) { topSection = y0; }
                 else if ( extent[1] - dy > y1 ) { topSection = y1 - size; }
                 else { topSection = extent[0] - dy; }

                 //Make sure the page doesn't scroll as well
                 d3.event.stopPropagation();
                 d3.event.preventDefault();

                 gBrush
                     .call(brush.extent([ topSection, topSection + size ]))
                     .call(brush.event);

             }//scroll

             /////////////////////////////////////////////////////////////
             ///////////////////// Helper functions //////////////////////
             /////////////////////////////////////////////////////////////

             //Create a gradient
             function createGradient(idName, endPerc) {

                 var coloursRainbow = ["#EFB605", "#E9A501", "#E48405", "#E34914", "#DE0D2B", "#CF003E", "#B90050", "#A30F65", "#8E297E", "#724097", "#4F54A8", "#296DA4", "#0C8B8C", "#0DA471", "#39B15E", "#7EB852"];

                 defs.append("linearGradient")
                     .attr("id", idName)
                     .attr("gradientUnits", "userSpaceOnUse")
                     .attr("x1", "0%").attr("y1", "0%")
                     .attr("x2", endPerc).attr("y2", "0%")
                     .selectAll("stop")
                     .data(coloursRainbow)
                     .enter().append("stop")
                     .attr("offset", function(d,i) { return i/(coloursRainbow.length-1); })
                     .attr("stop-color", function(d) { return d; });
             }//createGradient

             function loadData(arr){
                 initdata = arr;
                 numConclines = initdata.length;
                 removedKeys = new Set();
                 data = initdata[0];
                 elements = Object.keys(data);
                 elements.splice(elements.indexOf('ID'), 1);
                 elements.splice(elements.indexOf('Title'), 1);
                 var tempdata = elements[0];
                 elements[0]= elements[1];
                 elements[1] = tempdata;
                 document.getElementById("dropdown").value = elements[0];

                 dataProcessMetafacet(elements[0]);
             }

             function dataProcessMetafacet(attribute) {
                 metasvg.selectAll("*").remove();
                 var temp = initdata
                 if (attribute === "Organisation"){
                     for (const dp in initdata) {
                         orgs =initdata[dp]["Organisation"].split(" ")
                            if(orgs.length > 1){
                                temp[dp]["Organisation"] = orgs[0]
                                for (let i = 1; i < orgs.length ; i++) {
                                    var tempItem = temp[dp]
                                    tempItem["Organisation"] = orgs[i];
                                    temp.push(tempItem);
                                }
                         }
                     }
                 }

                 var nameCount = d3.nest()
                                   .key(function(d) {
                                   if(d[attribute].trim() === ""){
                                       return "N/A"
                                   }else{ return d[attribute] }})
                                   .rollup(function(v) { return v.length; })
                                   .entries(temp);

                 if(shouldSort)
                     nameCount= nameCount.sort(function(a, b){ return d3.descending(a.values, b.values); });
                 nested = d3.nest()
                            .key(function(d) { return d[attribute]; })
                            .entries(initdata);

                 data = nameCount;
                 init();
             }

             function remove(key){
                 toRemoveAtts.add(key)
                 var metatext = document.getElementById("metatextbox")
                 var ihtml = "";
                 for (const item of toRemoveAtts) {
                    if(item === ""){
                         ihtml+= "\'"+"N/A"+"\' ";
                     }else{
                         ihtml+= "\'"+item+"\' ";
                     }
                 }
                 metatext.innerHTML = ihtml;
                 nested.map(function(m) {
                     if (m.key === key) {
                         m.values.map(function (v) {

                             if (v.ID === "ignore") {

                                 removedKeys.add(v.Filename + v.ID );
                                 toberemovedViaMetafacet.add(v.Filename+".xml");

                             } else {
                                  removedKeys.add(v.Filename + v.ID);
                                  toberemovedViaMetafacet.add(v.Filename+".xml"+ v.ID);
                             }
                         });
                     }
                 });

             }

             function hide() {
                toberemovedViaMetafacet.forEach(element => {
                    removedViaMetafacet.add(element);
                });
                let a = Array.from(toRemoveAtts);
                 for (const item of a) {
                     removeAtts.add(item)
                 }
                 var metatext1 = document.getElementById("metatextbox1")
                 var ihtml = "";
                 for (const item of removeAtts) {
                     if(item === ""){
                         ihtml+= "\'"+"N/A"+"\' ";
                     }else{
                         ihtml+= "\'"+item+"\' ";
                     }

                 }
                 metatext1.innerHTML = ihtml;

                 dataProcess(currentData,currentKeyword);
                 dataProcessMosaic(currentData,currentKeyword);
                 buildConcMetadata();

                 toberemovedViaMetafacet = new Set();
                 removedKeys = new Set();
             }



             function add(key){
                 toRemoveAtts.delete(key)
                 var metatext = document.getElementById("metatextbox")
                 var ihtml = "";
                 for (const item of toRemoveAtts) {
                    ihtml+= "\'"+item+"\' ";
                 }
                 metatext.innerHTML = ihtml;
                 nested.map(function(m) {
                     if (m.key === key) {
                         m.values.map(function (v) {
                             if (v.ID === "ignore") {
                                 removedKeys.delete(v.Filename + v.ID);
                                 toberemovedViaMetafacet.delete(v.Filename+".xml");
                             }
                              else {
                                     removedKeys.delete(v.Filename  + v.ID);
                                     toberemovedViaMetafacet.delete(v.Filename+".xml" + v.ID);
                             }
                         });
                     }
                 });

             }

             function wrap(text, width) {
                 text.each(function() {
                     var text = d3.select(this),
                         words = text.text().replaceAll("_"," ").split(/\s+/).reverse(),
                         word,
                         line = [],
                         lineNumber = 0,
                         lineHeight = 1, // ems
                         y = text.attr("y"),
                         x = text.attr("x"),
                         dy = parseFloat(text.attr("dy")),
                         tspan = text.text(null).append("tspan").attr("x", x).attr("y", y).attr("dy", dy + "em");
                     while (word = words.pop()) {
                         line.push(word);
                         tspan.text(line.join(" "));
                         if (tspan.node().getComputedTextLength() > main_width/2.8) {
                             line.pop();
                             tspan.text(line.join(" "));
                             line = [word];
                             tspan = text.append("tspan").attr("x", x).attr("y", y).attr("dy", ++lineNumber * lineHeight + dy + "em").text(word);
                         }
                     }
                 });
             }
            </script>
  </body>
</html>
